<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>开源最佳实践</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../preface.html">前言</a></li><li class="chapter-item expanded "><a href="../1/1.html"><strong aria-hidden="true">1.</strong> Hello Node.js v20</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../1/1.1.html"><strong aria-hidden="true">1.1.</strong> Node.js v20</a></li><li class="chapter-item expanded "><a href="../1/1.2.html"><strong aria-hidden="true">1.2.</strong> Node.js安装</a></li><li class="chapter-item expanded "><a href="../1/1.3.html"><strong aria-hidden="true">1.3.</strong> Node.js模块</a></li><li class="chapter-item expanded "><a href="../1/1.4.html"><strong aria-hidden="true">1.4.</strong> 第一个Node.js v20项目</a></li><li class="chapter-item expanded "><a href="../1/1.5.html"><strong aria-hidden="true">1.5.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../2/2.html"><strong aria-hidden="true">2.</strong> Hello TypeScript</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2/2.1.html"><strong aria-hidden="true">2.1.</strong> TypeScript是什么</a></li><li class="chapter-item expanded "><a href="../2/2.2.html"><strong aria-hidden="true">2.2.</strong> TypeScript安装</a></li><li class="chapter-item expanded "><a href="../2/2.3.html"><strong aria-hidden="true">2.3.</strong> TypeScript基础</a></li><li class="chapter-item expanded "><a href="../2/2.4.html"><strong aria-hidden="true">2.4.</strong> TypeScript进阶</a></li><li class="chapter-item expanded "><a href="../2/2.5.html"><strong aria-hidden="true">2.5.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../3/3.html"><strong aria-hidden="true">3.</strong> 你的第一个TS编写的Node.js项目</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../3/3.1.html"><strong aria-hidden="true">3.1.</strong> 项目实战</a></li><li class="chapter-item expanded "><a href="../3/3.2.html"><strong aria-hidden="true">3.2.</strong> Tsx编译</a></li><li class="chapter-item expanded "><a href="../3/3.3.html"><strong aria-hidden="true">3.3.</strong> TSDoc文档</a></li><li class="chapter-item expanded "><a href="../3/3.4.html"><strong aria-hidden="true">3.4.</strong> Tsup发布</a></li><li class="chapter-item expanded "><a href="../3/3.5.html"><strong aria-hidden="true">3.5.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../4/4.html"><strong aria-hidden="true">4.</strong> 用VSCode调试项目</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../4/4.1.html"><strong aria-hidden="true">4.1.</strong> VSCode+Cursor必杀技</a></li><li class="chapter-item expanded "><a href="../4/4.2.html"><strong aria-hidden="true">4.2.</strong> Node.js调试</a></li><li class="chapter-item expanded "><a href="../4/4.3.html"><strong aria-hidden="true">4.3.</strong> TS+Node.js调试</a></li><li class="chapter-item expanded "><a href="../4/4.4.html"><strong aria-hidden="true">4.4.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../5/5.html"><strong aria-hidden="true">5.</strong> 给Node.js项目增加TS测试</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../5/5.1.html"><strong aria-hidden="true">5.1.</strong> 增加TS测试</a></li><li class="chapter-item expanded "><a href="../5/5.2.html"><strong aria-hidden="true">5.2.</strong> 常用测试技巧进阶</a></li><li class="chapter-item expanded "><a href="../5/5.3.html"><strong aria-hidden="true">5.3.</strong> 学会CI/CD</a></li><li class="chapter-item expanded "><a href="../5/5.4.html"><strong aria-hidden="true">5.4.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../6/6.html"><strong aria-hidden="true">6.</strong> Monorepo多模块开发实践</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../6/6.1.html"><strong aria-hidden="true">6.1.</strong> 开发你的第一个模块</a></li><li class="chapter-item expanded "><a href="../6/6.2.html" class="active"><strong aria-hidden="true">6.2.</strong> 开源最佳实践</a></li><li class="chapter-item expanded "><a href="../6/6.3.html"><strong aria-hidden="true">6.3.</strong> 如何学习</a></li><li class="chapter-item expanded "><a href="../6/6.4.html"><strong aria-hidden="true">6.4.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../7/7.html"><strong aria-hidden="true">7.</strong> 使用Hono做Web开发</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../7/7.1.html"><strong aria-hidden="true">7.1.</strong> Hono框架</a></li><li class="chapter-item expanded "><a href="../7/7.2.html"><strong aria-hidden="true">7.2.</strong> 使用ORpc + Scalar做API开发</a></li><li class="chapter-item expanded "><a href="../7/7.3.html"><strong aria-hidden="true">7.3.</strong> 使用Cella开发Web应用</a></li><li class="chapter-item expanded "><a href="../7/7.4.html"><strong aria-hidden="true">7.4.</strong> 监控Apitally</a></li><li class="chapter-item expanded "><a href="../7/7.5.html"><strong aria-hidden="true">7.5.</strong> 本章小结</a></li></ol></li><li class="chapter-item expanded "><a href="../appendix.html"><strong aria-hidden="true">8.</strong> 附录</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/npmstudy/Your-First-Node.js-with-TypeScript-Course" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="开源最佳实践"><a class="header" href="#开源最佳实践">开源最佳实践</a></h1>
<p>在 <a href="https://github.com/npmstudy/your-node-v20-monorepo-project">https://github.com/npmstudy/your-node-v20-monorepo-project</a> 里，我们用到的技术栈如下。</p>
<pre><code class="language-markdown">- [Tsup](https://tsup.egoist.dev/) as a TypeScript universal package.
- [Tsx](https://github.com/esbuild-kit/tsx) as a Node.js enhanced with esbuild to run TypeScript &amp; ESM
- [Tsd](https://github.com/SamVerschueren/tsd) as type test runner
- [Tsdoc](https://tsdoc.org/) as document
- [PNPM](https://pnpm.io/workspaces) as workspace manager and package manager.
- [Vitest](https://vitest.dev/) as a test runner.
- [Size Limit](https://github.com/ai/size-limit) as a size limit plugin.
- [Prettier](https://prettier.io/) as a code formatter.
- [ESLint](https://eslint.org/) as a code linter.
- [NX](https://nx.dev) as cacheable operations.
- [Changesets](https://github.com/changesets/changesets/) as a way to manage changes and releases.
- [c8](https://www.npmjs.com/package/c8) as coverage
- [supertest](https://www.npmjs.com/package/supertest) as server test
- [cypress](https://www.cypress.io/) as e2e test
</code></pre>
<p>运行TS的4个（已讲过）</p>
<ol>
<li>tsup</li>
<li>tsx</li>
<li>tsd</li>
<li>tsdoc</li>
</ol>
<p>模块安装和monorepo</p>
<ol>
<li>pnpm</li>
</ol>
<p>测试</p>
<ol>
<li>Vitest</li>
<li>c8（已讲过）</li>
<li>supertest</li>
<li>cypress</li>
</ol>
<p>其他</p>
<ol>
<li>Size-limit</li>
<li>NX</li>
<li>ESLint</li>
<li>Prettier</li>
<li>Changesets</li>
</ol>
<p>其中ESLint和Prettier前端同学都熟悉，这里就细讲了。</p>
<ul>
<li>ESLint是一个用于JavaScript和JSX代码的静态代码分析工具。它可以帮助开发者在编写代码的过程中发现并修复潜在的问题，以确保代码的质量和一致性。</li>
<li>Prettier是一个代码格式化工具，用于自动格式化代码以保持一致的代码风格。它支持多种编程语言，包括JavaScript、CSS、HTML、JSON等。Prettier可以帮助开发者快速、准确地格式化代码，提高代码的可读性和可维护性。它可以与其他代码检查工具（如ESLint）配合使用，以确保代码的质量和一致性。</li>
</ul>
<p>它俩是VSCode非常常见的搭档。</p>
<h2 id="pnpm"><a class="header" href="#pnpm">Pnpm</a></h2>
<p>包管理演进历史，参考<a href="https://zhuanlan.zhihu.com/p/582229306">https://zhuanlan.zhihu.com/p/582229306</a>，各个包管理器对比如下。</p>
<p>pnpm在2018年发布，作为npm的更快速和更高效的替代品。</p>
<p><img src="img/Untitled%202.png" alt="Untitled" /></p>
<p>选择pnpm的原因，第一个就是安装速度快，参考官方的<a href="https://pnpm.io/benchmarks">https://pnpm.io/benchmarks</a>基准测试数据。</p>
<div class="table-wrapper"><table><thead><tr><th>行为</th><th>缓存</th><th>lockfile</th><th>node_modules</th><th>npm</th><th><strong>pnpm</strong></th><th>Yarn</th><th>Yarn PnP</th></tr></thead><tbody>
<tr><td>install</td><td></td><td></td><td></td><td>34.3s</td><td>13.2s</td><td>22.1s</td><td>20.2s</td></tr>
<tr><td>install</td><td>✔</td><td>✔</td><td>✔</td><td>2.5s</td><td>1.6s</td><td>695ms</td><td>n/a</td></tr>
<tr><td>install</td><td>✔</td><td>✔</td><td></td><td>9.5s</td><td>4.8s</td><td>8.8s</td><td>668ms</td></tr>
<tr><td>install</td><td>✔</td><td></td><td></td><td>15.5s</td><td>9.3s</td><td>22.8s</td><td>15.2s</td></tr>
<tr><td>install</td><td></td><td>✔</td><td></td><td>19.3s</td><td>9.8s</td><td>8.9s</td><td>670ms</td></tr>
<tr><td>install</td><td>✔</td><td></td><td>✔</td><td>2.8s</td><td>3.4s</td><td>16s</td><td>n/a</td></tr>
<tr><td>install</td><td></td><td>✔</td><td>✔</td><td>2.5s</td><td>1.7s</td><td>681ms</td><td>n/a</td></tr>
<tr><td>install</td><td></td><td></td><td>✔</td><td>2.8s</td><td>8.8s</td><td>16.6s</td><td>n/a</td></tr>
<tr><td>update</td><td>n/a</td><td>n/a</td><td>n/a</td><td>9.2s</td><td>5.8s</td><td>8.7s</td><td>16.9s</td></tr>
</tbody></table>
</div>
<p>还有一些其他特性</p>
<p><img src="img/Untitled%203.png" alt="Untitled" /></p>
<p>pnpm使用的是npm version 2.x类似的树形结构，同时使用.pnpm 以平铺的形式储存着所有的包。这里的.pnpm为虚拟存储目录，该目录通过<code>&lt;package-name&gt;@&lt;version&gt;</code>来实现相同模块不同版本之间隔离和复用，由于它只会根据项目中的依赖生成，并不存在提升，所以它不会存在之前提到的<strong>Phantom dependencies</strong>问题！</p>
<p>然后使用Store + Links和文件资源进行关联。简单说pnpm把会包下载到一个公共目录，如果某个依赖在 store 目录中存在了话，那么就会直接从 store 目录里面去 hard-link，避免了二次安装带来的时间消耗，如果依赖在 store 目录里面不存在的话，就会去下载一次。</p>
<p>通过Store + hard link的方式，不仅解决了项目中的NPM doppelgangers问题，项目之间也不存在该问题，从而完美解决了npm3+和yarn中的包重复问题！</p>
<p><img src="img/Untitled%204.png" alt="Untitled" /></p>
<p>pnpm除了安装速度快，节省磁盘空间，避免幽灵依赖等优化，也内置了对monorepo的支持。使用起来比较简单，在项目根目录中新建pnpm-workspace.yaml文件，并声明对应的工作区就好。</p>
<pre><code class="language-tsx">$ cat pnpm-workspace.yaml
packages:
  - 'example'
  - 'packages/*'

</code></pre>
<p>剩下的就是运行时处理。之前nx run-many解决了monorepo子模块运行的问题。很多时候我们需要在根目录执行某个项目 的构建脚本，需要通过—filter或-F过滤之后，再执行，示例如下。</p>
<pre><code class="language-tsx">$ pnpm -F example dev
</code></pre>
<p>以上都是pnpm的有点，其实pnpm的演进还是比较快的，比如pnpm v7和pnpm v8版本差异还是比较大的，且不完全兼容。但整个社区是比较活跃的，</p>
<aside>
💡 都说Node.js和前端复杂，其实是背后工程复杂度导致的，如果没有这么多依赖，这么多版本，也不会出现幻影依赖这样的问题。其实，对用的人来说无感的，我就用pnpm v8，像其他社区一样，也没问题的。真正的问题是Node.js和前端变化太快，你在较短时间内，总可能会遇到pnpm v7的代码，甚至互相切换。
</aside>
<h2 id="vitest"><a class="header" href="#vitest">Vitest</a></h2>
<ul>
<li>
<p><strong>A Vite-native unit test framework.</strong></p>
<p><strong>It's fast!</strong></p>
</li>
</ul>
<p>优点：</p>
<ol>
<li>基于vite机制，性能极佳，比jest快很多，</li>
<li>对esm支持极好</li>
<li>兼容jest api</li>
<li>很多技术选型也都是非常棒，比如tinypool，都是很经典的。</li>
</ol>
<p>如果我们想要从请求开始来测试node服务接口返回的数据是否正常，也就是说进行一个整体性测试，那么 superTest 就是一个非常好的选择。superTest可以帮助我们去请求本地 koa 或者 express这类web框架所编写的路由接口，而且对接口返回的状态码、数据等进行断言校验。</p>
<p>它本身不依赖任何测试框架，所以我们可以直接把它丢到mocha的测试用例中执行：</p>
<p>先写一个简单的Koa的Hello world。见app.js</p>
<pre><code class="language-tsx">import Koa from &quot;koa&quot;;
const app = new Koa();

// response
app.use((ctx) =&gt; {
  ctx.body = &quot;Hello Koa&quot;;
});

export default app;
</code></pre>
<p>再写一个测试脚本，run.js</p>
<pre><code class="language-tsx">import app from &quot;./index.js&quot;;

app.listen(3000);
</code></pre>
<p>此时，执行node run.js就可以启动服务了。然后我们看一下测试如何编写。</p>
<pre><code class="language-tsx">import { expect, test } from &quot;vitest&quot;;
import supertest from &quot;supertest&quot;;
import app from &quot;./index.js&quot;;

test(&quot;koa app&quot;, async () =&gt; {
  const res = await supertest(app.callback()).get(&quot;/&quot;);

  expect(res.type).toEqual(&quot;text/plain&quot;);
  expect(res.status).toEqual(200);
  expect(res.text).toEqual(&quot;Hello Koa&quot;);
});
</code></pre>
<p>这个代码和我们在Node.js v20的test runner里几乎是一模一样的。通过下面命令即可运行测试。</p>
<pre><code class="language-tsx">$ npx vitest run

 RUN  v0.34.6 /Users/alfred/workspace/npmstudy/vitest-with-supertest

 ✓ index.test.js (1)
   ✓ koa app

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  11:56:53
   Duration  232ms (transform 17ms, setup 0ms, collect 69ms, tests 8ms, environment 0ms, prepare 44ms)
</code></pre>
<p>说明。</p>
<ul>
<li>vitest不带run参数，是watch运行模式，和jest类似</li>
<li>vitest带run参数，是单次运行模式</li>
</ul>
<h2 id="cypress"><a class="header" href="#cypress">Cypress</a></h2>
<p>安装</p>
<pre><code class="language-tsx">$ npm install cypress --save-dev --registry=https://registry.npmmirror.com
</code></pre>
<p>通过npx cypress open打开。</p>
<pre><code class="language-tsx">$ npx cypress open
It looks like this is your first time using Cypress: 13.3.0

✔  Verified Cypress! /Users/alfred/Library/Caches/Cypress/13.3.0/Cypress.app

Opening Cypress...

DevTools listening on ws://127.0.0.1:54097/devtools/browser/dc560ea2-0aad-47a4-9461-1e160b19a5a3
</code></pre>
<p><img src="img/Untitled%205.png" alt="Untitled" /></p>
<p><img src="img/Untitled%206.png" alt="Untitled" /></p>
<p><img src="img/Untitled%207.png" alt="Untitled" /></p>
<p><img src="img/Untitled%208.png" alt="Untitled" /></p>
<p>修改代码，手动执行node run.js启动服务。</p>
<pre><code class="language-tsx">describe(&quot;template spec&quot;, () =&gt; {
  it(&quot;passes&quot;, () =&gt; {
    cy.visit(&quot;http://127.0.0.1:3000&quot;);
    cy.contains(&quot;Hello Koa&quot;);
  });
});
</code></pre>
<p><img src="img/Untitled%209.png" alt="Untitled" /></p>
<p>为了简化操作，我们把启动服务放到cypress.config.js里。</p>
<pre><code class="language-tsx">import { defineConfig } from &quot;cypress&quot;;
import app from &quot;./index.js&quot;;
export default defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
      on(&quot;before:run&quot;, async (details) =&gt; {
        /* ... */
        await app.listen(3000);
      });
    },
  },
});
</code></pre>
<p>此时，执行结果如下。</p>
<pre><code class="language-tsx">$ npx cypress run

DevTools listening on ws://127.0.0.1:61755/devtools/browser/0a2f2716-10cb-49b9-a2c9-5163469574e9

====================================================================================================

  (Run Starting)

  ┌────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ Cypress:        13.3.0                                                                         │
  │ Browser:        Electron 114 (headless)                                                        │
  │ Node Version:   v20.6.1 (/Users/alfred/.nvm/versions/node/v20.6.1/bin/node)                    │
  │ Specs:          1 found (spec.cy.js)                                                           │
  │ Searched:       cypress/e2e/**/*.cy.{js,jsx,ts,tsx}                                            │
  └────────────────────────────────────────────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────────────────────────

  Running:  spec.cy.js                                                                      (1 of 1)

  template spec
    ✓ passes (27ms)

  1 passing (47ms)

  (Results)

  ┌────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ Tests:        1                                                                                │
  │ Passing:      1                                                                                │
  │ Failing:      0                                                                                │
  │ Pending:      0                                                                                │
  │ Skipped:      0                                                                                │
  │ Screenshots:  0                                                                                │
  │ Video:        false                                                                            │
  │ Duration:     0 seconds                                                                        │
  │ Spec Ran:     spec.cy.js                                                                       │
  └────────────────────────────────────────────────────────────────────────────────────────────────┘

====================================================================================================

  (Run Finished)

       Spec                                              Tests  Passing  Failing  Pending  Skipped
  ┌────────────────────────────────────────────────────────────────────────────────────────────────┐
  │ ✔  spec.cy.js                                42ms        1        1        -        -        - │
  └────────────────────────────────────────────────────────────────────────────────────────────────┘
    ✔  All specs passed!                         42ms        1        1        -        -        -
</code></pre>
<p>Cypress写e2e测试还是非常简单的，它也支持测试覆盖率，也可以生产reporter，和我们在上一章节学到的c8类似，大家如果感兴趣也可以自己实现一下。</p>
<p>除此之外，Cypress还支持组件级别测试，可以说又是填补了一块空白，意义非凡，对于开发组件库来说，也是必不可少的功能。</p>
<h2 id="size-limit"><a class="header" href="#size-limit">Size-limit</a></h2>
<p>size-limit 是一个防止 JavaScript 库膨胀的工具，用于控制文件包的大小。如果不小心添加了大量的依赖关系，size-limit 会引发错误。</p>
<p>limit-size 是一个用于控制文件包大小的工具，它可以读取文件的大小，并与设置的文件大小进行比较。</p>
<p><img src="img/Untitled%2010.png" alt="Untitled" /></p>
<p>使用GitHub操作Size Limit将在拉取请求讨论中作为评论发布捆绑大小更改。</p>
<p><img src="img/Untitled%2011.png" alt="Untitled" /></p>
<p>也可以结合<a href="https://github.com/statoscope/statoscope">https://github.com/statoscope/statoscope</a> 进行分析。</p>
<p> <a href="https://www.smashingmagazine.com/2022/02/statoscope-course-intensive-therapy-bundle/">Statoscope: A Course Of Intensive Therapy For Your Bundle</a>.</p>
<p><img src="img/Untitled%2012.png" alt="Untitled" /></p>
<h2 id="nx"><a class="header" href="#nx">Nx</a></h2>
<aside>
💡 Nrwl(开源构建系统NX背后的公司)已经接管了Lerna。NX是一个由前谷歌员工开发的构建系统，它利用了谷歌内部工具使用的许多技术。Lerna v5是这种新管理方式下的第一个版本，它更新了过时的包，并开始对存储库本身进行一些清理。从V5.1+开始，Lerna提供了集成NX的新可能性，并将许多任务调度工作推迟到NX。
</aside>
<p>在使用Monorepo时，你一定听说过 Nx。简而言之，Nx 可以加快和简化与Monorepo的工作，并提供有用的实用程序。</p>
<p>官方介绍：</p>
<blockquote>
<p>Nx是一个智能、快速和可扩展的构建系统，具有一流的Monorepo支持和强大的集成。</p>
</blockquote>
<p>Nx的目标是：</p>
<ul>
<li>加快你的前端项目工程化</li>
<li>提供一流的开发体验</li>
</ul>
<p>大部分情况需要了解的就是下面6个指点就够了。</p>
<ul>
<li>nx run-many</li>
<li>dependency graph + nx affected</li>
<li>nx-enforce-module-boundaries es-linting</li>
<li>computation cache</li>
<li>nx cloud</li>
<li>buildable libs</li>
</ul>
<p>nx会自动引入上一次build的cache缓存，从而加快编译速度.在<a href="https://nx.dev/concepts/how-caching-works">How Caching Works</a>这篇文章中非常详细地说明了 nx 缓存构建结果的机制：</p>
<p>nx 会计算当前执行的 target 的 Hash 作为 cache key，在 target 执行完成后把构建输出（包括终端输出、构建结果文件）作为缓存内容存储起来。</p>
<p><img src="img/Untitled%2013.png" alt="Untitled" /></p>
<p>最常用的动作</p>
<ul>
<li>将所有的子项目统一打包编译，命令:<code>npx nx run-many --target=build</code></li>
<li>如果不需要使用cache缓存，可以使用命令:<code>npx nx run-many --target=build --skip-nx-cache</code></li>
<li>如果需要查看当前子项目依赖的项目是否被修改，可以使用命令：<code>npx nx affected --target=build</code></li>
<li>如果需要查看当前子项目依赖的图，可以使用命令：<code>npx nx graph</code></li>
</ul>
<p>比如依赖如下。</p>
<pre><code class="language-tsx">$ pnpm project-graph

&gt; your-node-v20-monorepo-project@ project-graph /Users/alfred/workspace/npmstudy/your-node-v20-monorepo-project
&gt; nx graph

 &gt;  NX   Project graph started at http://127.0.0.1:4211/projects
</code></pre>
<p><img src="img/Untitled%2014.png" alt="Untitled" /></p>
<p>nx除了本地换成，其实还支持云服务（remote cache）。即nx.app，如果真的对ci/cd有极强的需求，其实也是可以考虑选择的。</p>
<p><img src="img/Untitled%2015.png" alt="Untitled" /></p>
<p>在<a href="https://github.com/npmstudy/your-node-v20-monorepo-project">https://github.com/npmstudy/your-node-v20-monorepo-project</a> 项目里，我们其实只用了非常简单的npm nx run-many</p>
<pre><code class="language-tsx">   &quot;build&quot;: &quot;nx run-many -t build&quot;,
    &quot;build:fast&quot;: &quot;nx run-many -t build:fast&quot;,
    &quot;dev&quot;: &quot;nx run-many -t dev&quot;,
    &quot;test&quot;: &quot;nx run-many -t test&quot;,
</code></pre>
<p>虽然多了一个nx模块，但执行的时候能够利用本地缓存，加快打包、测试速度，已经是非常好的事儿。</p>
<h2 id="changesets"><a class="header" href="#changesets">Changesets</a></h2>
<p>Changesets 是一个用于 Monorepo 项目下版本以及 Changelog 文件管理的工具。目前一些比较火的 Monorepo 仓库都在使用该工具进行项目的发包例如 pnpm、mobx 等。</p>
<p>changesets 主要关心 monorepo 项目下子项目版本的更新、changelog 文件生成、包的发布。一个 changeset 是个包含了在某个分支或者 commit 上改动信息的 md 文件，它会包含这样一些信息:</p>
<ul>
<li>需要发布的包</li>
<li>包版本的更新层级(遵循 semver 规范)</li>
<li>CHANGELOG 信息</li>
</ul>
<p>在 changesets 工作流会将开发者分为两类人，一类是项目的维护者，还有一类为项目的开发者，两者的职责可以通过如下流程图很简洁的表示出来:</p>
<p><img src="img/Untitled%2016.png" alt="Untitled" /></p>
<p>根据上图， changesets 的工作流程是这样：开发者在 Monorepo 项目下进行开发，开发完成后，给对应的子项目添加一个 changesets 文件。项目的维护者后面会通过 changesets 来消耗掉这些文件并自动修改掉对应包的版本以及生成 CHANGELOG 文件，最后将对应的包发布出去。</p>
<p>常用的命令只有add、version、publish</p>
<p><img src="img/Untitled%2017.png" alt="Untitled" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../6/6.1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../6/6.3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../6/6.1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../6/6.3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

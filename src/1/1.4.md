# 1.4ã€ç¬¬ä¸€ä¸ªNode.js v20é¡¹ç›®

å­¦ä¹ ä»»ä½•æŠ€æœ¯ï¼Œæœ€å¥½çš„æ–¹å¼éƒ½æ˜¯ä»Helloworldå¼€å§‹ï¼Œèƒ½å¤ŸæŠŠHelloworldåšåˆ°æè‡´ï¼Œæ ‡å‡†ï¼Œå†…èšï¼Œå…¶å®ä¹Ÿæ˜¯éå¸¸éš¾çš„ã€‚

ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€èµ·çœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªNode.js v20é¡¹ç›®å¦‚ä½•ç¼–å†™å§ã€‚

## è¦ç‚¹

æ¨èåšæ³•ï¼Œèƒ½ä½¿ç”¨ç°ä»£Webè§„èŒƒçš„åœ°æ–¹å°½é‡ä½¿ç”¨ã€‚

1ã€ä½¿ç”¨ESMè§„èŒƒï¼Œä½œä¸ºæ¨¡å—åŠ è½½æ–¹æ¡ˆï¼ŒæŒæ¡importå’Œexportå°±å¯ä»¥

2ã€ä½¿ç”¨import xx from â€˜node:xxxâ€™è°ƒç”¨

3ã€é…ç½®package.jsonä¸­çš„"type": "module"ï¼Œä½¿ç”¨.jsåç¼€è¿›è¡Œå¼€å‘

4ã€ä½¿ç”¨Asyncå‡½æ•°ä½œä¸ºå¼‚æ­¥æµç¨‹æ–¹æ¡ˆï¼Œå¦‚æœå¿…é¡»è¦ä½¿ç”¨Promise

## åˆå§‹åŒ–é¡¹ç›®

é€šè¿‡npm init -yåˆ›å»ºé¡¹ç›®

![Untitled](img/Untitled%209.png)

è¿™æ˜¯npmé»˜è®¤åˆ›å»ºçš„package.jsonï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰é…ç½®ESæ¨¡å—ä¿¡æ¯ã€‚éœ€è¦æ‰‹åŠ¨ç¼–å†™ï¼Œå¢åŠ "type": "module"ã€‚æ­¤æ—¶ï¼Œpackage.jsonæ–‡ä»¶å†…å®¹å¦‚ä¸‹ã€‚

```bash
{
  "name": "helloworld",
  "version": "1.0.0",
  "description": "",
  "type": "module",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
```

## åˆ›å»ºindex.js

ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¹‹å‰çš„ä»£ç ã€‚

```bash
// å®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°
async function sayHi(name) {
  try {
    // è°ƒç”¨Promiseå‡½æ•°
    const text = await helloworld(name);
    console.dir(text);
  } catch (error) {
    console.log(error);
  }
}

// è°ƒç”¨Promiseå‡½æ•°
function helloworld(name) {
  return new Promise(function (resolve, reject) {
    resolve(`Hello ${name}!`);
  });
}

// è°ƒç”¨å¼‚æ­¥å‡½æ•°
const person = process.argv[2];

sayHi(person);
```

æ‰§è¡Œå¦‚ä¸‹ã€‚

```bash
$ node index.js alfred
'Hello alfred!'
```

å‚è€ƒ

- [https://nodejs.dev/en/learn/run-nodejs-scripts-from-the-command-line/](https://nodejs.dev/en/learn/run-nodejs-scripts-from-the-command-line/)
- https://github.com/75lb/command-line-args
- https://github.com/75lb/command-line-usage

## å‘å¸ƒnpm

å‰ç½®æ¡ä»¶æ˜¯npmjs.comä¸Šæ³¨å†Œå¹¶ç™»å½•.

![Untitled](img/Untitled%2010.png)

ä¿®æ”¹package.jsonå¦‚ä¸‹

```bash
{
  "name": "node-v20-helloworld",
  "version": "1.0.5",
  "description": "",
  "type": "module",
  "main": "index.js",
  "bin": {
    "node-v20-helloworld": "index.js"
  },
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "npmtudy",
  "license": "ISC",
  "files": [
    "index.js"
  ],
  "engines": {
    "node": "^20"
  }
}
```

è¯´æ˜

- bin æ˜¯é…ç½®cliåç§°çš„é…ç½®ã€‚
- files æ˜¯å‘å¸ƒçš„npmåŒ…é‡ŒåŒ…å«çš„å†…å®¹ï¼Œæ¯”å¦‚æµ‹è¯•ä¹‹ç±»çš„åªåœ¨å¼€å‘é˜¶æ®µä½¿ç”¨ï¼ŒçœŸæ­£çš„npmåŒ…é‡Œå¯ä»¥ç§»é™¤æ‰ã€‚
- engines ç”¨äºé™åˆ¶nodeç‰ˆæœ¬ï¼Œæ¯”å¦‚è¿™é‡Œçš„é…ç½®å°±æ˜¯Node.js v20ä»¥ä¸Šæ‰èƒ½å®‰è£…ã€‚

ç„¶åæ‰§è¡Œnpm publishå°±å¯ä»¥æ­£å¸¸å‘å¸ƒï¼Œå¦‚æœä¸èƒ½å‘å¸ƒï¼Œå¯ä»¥é€šè¿‡npm verionè¿›è¡Œè°ƒæ•´ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„å°±æ˜¯ä¿®å¤é—®é¢˜ï¼Œé€šè¿‡patchæ¥ä¿®æ”¹æœ€åä¸€ä½çš„ç‰ˆæœ¬å·ã€‚

```bash
$ npm version patch
v1.0.6
```

## æµ‹è¯•

Node.jsè¯ç”Ÿè‡ª2009å¹´ï¼Œåœ¨v18ä¹‹å‰çš„13å¹´æ—¶é—´é‡Œéƒ½æ²¡æœ‰å†…ç½®ä»»ä½•æµ‹è¯•æ¡†æ¶ã€‚ä¸€ç›´éƒ½æ˜¯ä½¿ç”¨npmç”Ÿæ€ã€‚åƒæœ¬ä¹¦ç³»åˆ—å·ä¸‰ä¸­æåˆ°çš„å‡ ä¸ªæµ‹è¯•æ¡†æ¶ï¼Œéƒ½å·²ç»æœ‰5å¹´ä»¥ä¸Šçš„å†å²äº†ã€‚

| æµ‹è¯•**æ¡†æ¶** | å½“å‰ä¸»è¦ç‰ˆæœ¬ | å¹´é™ |
| --- | --- | --- |
| mocha | v10 | 11 |
| tap | v16 | 11 |
| tape | v5 | 10 |
| ava | v5 | 9 |
| jest | v27 | 7 |

Node.jséµå¾ªä¸JavaScriptæœ¬èº«ç›¸åŒçš„"æœ€å°æ ¸å¿ƒ"åŸåˆ™ã€‚å› æ­¤ï¼Œåƒä»£ç æ£€æŸ¥å·¥å…·ã€ä»£ç æ ¼å¼åŒ–å·¥å…·å’Œæµ‹è¯•è¿è¡Œå™¨è¿™æ ·çš„å·¥å…·æœ€å¥½ä½œä¸ºç¬¬ä¸‰æ–¹å·¥å…·æä¾›ã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æƒ³æ³•å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œä½†ç°åœ¨æ²¡æœ‰æ ‡å‡†æµ‹è¯•å·¥å…·çš„ä»»ä½•è¯­è¨€éƒ½æ˜¾å¾—æœ‰äº›å¥‡æ€ªã€‚Denoã€Rustå’ŒGo - å®ƒä»¬éƒ½æœ‰è‡ªå·±å†…ç½®çš„æµ‹è¯•è¿è¡Œå™¨ã€‚

åœ¨Node.js v18å¼€å§‹å†…ç½®äº†æµ‹è¯•æ¡†æ¶ï¼Œåœ¨Node.js v20ç‰ˆæœ¬ä¸­ï¼Œå·²ç»è¢«æ ‡è®°ä¸ºStableèƒ½åŠ›ï¼Œå¤§å®¶å¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚

ä½¿ç”¨Node.js å†…ç½®çš„æµ‹è¯•æ¡†æ¶ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ã€‚

```bash

import { test } from "node:test";
import assert from "node:assert";

import { sayHi } from "./index.js";

test("test if works correctly", function (t) {
  const log = t.mock.method(global.console, "log");

  assert.strictEqual(log.mock.callCount(), 0);
  // call hello world say method
  sayHi("liangqi");

  assert.strictEqual(log.mock.callCount(), 1);
});
```

åœ¨package.jsonä¸­ä¿®æ”¹npm scripts

```bash
"scripts": {
    "test": "node --test"
},
```

æ‰§è¡Œæµ‹è¯•ç»“æœå¦‚ä¸‹ã€‚

```bash
$ npm test

> node-v20-helloworld@1.0.6 test
> node --test

Hello liangqi!
âœ– test if works correctly (1.703916ms)
  AssertionError [ERR_ASSERTION]: Expected values to be strictly equal:

  0 !== 1

      at TestContext.<anonymous> (file:///Users/alfred/workspace/npmstudy/node-v20-helloworld/index.test.js:13:10)
      at Test.runInAsyncScope (node:async_hooks:206:9)
      at Test.run (node:internal/test_runner/test:581:25)
      at Test.start (node:internal/test_runner/test:494:17)
      at startSubtest (node:internal/test_runner/harness:207:17) {
    generatedMessage: true,
    code: 'ERR_ASSERTION',
    actual: 0,
    expected: 1,
    operator: 'strictEqual'
  }

â„¹ tests 1
â„¹ suites 0
â„¹ pass 0
â„¹ fail 1
â„¹ cancelled 0
â„¹ skipped 0
â„¹ todo 0
â„¹ duration_ms 59.11425

âœ– failing tests:

âœ– test if works correctly (1.703916ms)
  AssertionError [ERR_ASSERTION]: Expected values to be strictly equal:

  0 !== 1

      at TestContext.<anonymous> (file:///Users/alfred/workspace/npmstudy/node-v20-helloworld/index.test.js:13:10)
      at Test.runInAsyncScope (node:async_hooks:206:9)
      at Test.run (node:internal/test_runner/test:581:25)
      at Test.start (node:internal/test_runner/test:494:17)
      at startSubtest (node:internal/test_runner/harness:207:17) {
    generatedMessage: true,
    code: 'ERR_ASSERTION',
    actual: 0,
    expected: 1,
    operator: 'strictEqual'
  }
```

ç«Ÿç„¶æŠ¥é”™äº†ï¼è¿™å°±å¾ˆè«åå¥‡å¦™ï¼Œæ–¹æ³•è°ƒç”¨éƒ½æ˜¯å¯¹çš„ï¼Œæ–­è¨€ä¹Ÿæ²¡é—®é¢˜ã€‚

åç»è¿‡æ’æŸ¥ï¼Œå‘ç°sayHiæ˜¯Asyncå‡½æ•°ï¼Œåœ¨æµ‹è¯•æ–¹æ³•é‡Œï¼Œæ²¡æœ‰ä½¿ç”¨awaitæ¥å¯¹æ¥ã€‚éœ€è¦ä¿®æ”¹2å¤„ã€‚

- test("test if works correctly", async function (t) {})ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼Œéœ€è¦ä¿®å™¶ä»¥ä¸ºAsyncå‡½æ•°ï¼Œè¿™æ˜¯å› ä¸ºawaitå¤–å±‚å¿…é¡»æ˜¯asyncå‡½æ•°ã€‚
- sayHi("liangqi") æ–¹æ³•éœ€è¦æ”¹æˆawait sayHi("liangqi")ï¼Œè¿™æ ·å¼‚æ­¥æ–¹æ³•å°±è½¬æ¢ä¸ºåŒæ­¥æ–¹æ³•äº†ã€‚

å°†ä»£ç ä¿®æ”¹å¦‚ä¸‹

```bash
import { test } from "node:test";
import assert from "node:assert";

import { sayHi } from "./index.js";

test("test if works correctly", async function (t) {
  const log = t.mock.method(global.console, "log");

  assert.strictEqual(log.mock.callCount(), 0);
  // call hello world say method
  await sayHi("liangqi");

  assert.strictEqual(log.mock.callCount(), 1);
});

```

æ­¤æ—¶ï¼Œæ‰§è¡Œnpm test

```bash
$ npm test

> node-v20-helloworld@1.0.6 test
> node --test

Hello liangqi!
âœ” test if works correctly (1.092375ms)
â„¹ tests 1
â„¹ suites 0
â„¹ pass 1
â„¹ fail 0
â„¹ cancelled 0
â„¹ skipped 0
â„¹ todo 0
```

è‡³æ­¤ï¼Œå°±å®Œæˆäº†æµ‹è¯•çš„åŸºæœ¬æ­¥éª¤ï¼Œåªæœ‰CI/CDæˆ‘ä»¬åœ¨åé¢è¿›é˜¶ç« èŠ‚è¿›è¡Œè®²è§£ã€‚

<aside>
ğŸ’¡ Tipsï¼šè¿™ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­çš„å°æ’æ›²æ˜¯Node.jsæ–°æ‰‹æœ€å¸¸é­é‡çš„å¼‚æ­¥é™·é˜±ã€‚æ‰€æœ‰æ–¹æ³•çœ‹ç€æ²¡é—®é¢˜ï¼Œä½†å°±å°‘äº†ä¸€ä¸ªawaitï¼Œé‚£ä¸ªæ–¹æ³•å°±å¼‚æ­¥æ‰§è¡Œäº†ã€‚æ‰€ä»¥è¦æƒ³ç”¨å¥½Node.jsï¼Œç¬¬ä¸€è¦ä¹‰å°±æ˜¯æ—¶åˆ»æ³¨æ„å¼‚æ­¥æ“ä½œã€‚

</aside>

## æ¨¡å—ç”¨æ³•

npmä¸Šçš„æ¨¡å—åˆ†2ç§ã€‚

1. æ™®é€šæ¨¡å—ï¼Œä¸»è¦æ˜¯ä¸ºimport  fromä½¿ç”¨çš„ã€‚
2. äºŒè¿›åˆ¶æ¨¡å—ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç¼–å†™å‘½ä»¤è¡ŒCliå·¥å…·ä½¿ç”¨çš„ã€‚

ä¸‹é¢åˆ†åˆ«è¿›è¡Œæ¼”ç¤ºã€‚

æ–¹å¼1ï¼šé€šè¿‡äºŒè¿›åˆ¶æ¨¡å—æ–¹å¼æµ‹è¯•

```bash
$ npm i -g node-v20-helloworld
$ node-v20-helloworld liangqi
'Hello liangqi!'
```

æ–¹å¼2ï¼šä»£ç è°ƒç”¨

```bash
$ npm i --save node-v20-helloworld
```

è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼Œä¸€å®šè¦æ³¨æ„awaitï¼Œä¸Šé¢æµ‹è¯•éƒ¨åˆ†æœ‰è§è¿‡å‘ï¼Œä¸å¯å·æ‡’ã€‚

```bash
#! /usr/bin/env node
import { sayHi } from 'node-v20-helloworld';

async function main(){
	// è°ƒç”¨å¼‚æ­¥å‡½æ•°
	const person = process.argv[2];

	await sayHi(person);
}

main();
```


# å­¦ä¼šCI/CD

æ ‡å‡†å¼€å‘æµç¨‹é‡Œï¼Œåœ¨ä¹‹å‰ï¼Œå¼€å‘æµ‹è¯•å‘å¸ƒå¯èƒ½æ˜¯ä¸‰ä¸ªäººï¼Œç”±äºDevOpsçš„æµè¡Œå¯¼è‡´å¾ˆå¤šæ—¶å€™å¼€å‘æµ‹è¯•å‘å¸ƒæ˜¯ä¸€ä¸ªäººï¼Œäºæ˜¯è¡ç”Ÿå‡ºäº†å¾ˆå¤šCI/CDå¹³å°ã€‚

![Untitled](img/Untitled%204.png)

ä¸¾ä¸ªä¾‹å­ï¼Œä»¥å‰æˆ‘ä»¬å‘å¸ƒnpmæ¨¡å—ï¼Œåœ¨æœ¬åœ°æ‰§è¡Œnpm publishå³å¯ã€‚ç°åœ¨æµè¡Œçš„æ–¹å¼æ˜¯åœ¨ä»£ç mergeåˆ°mainåˆ†åˆ†æ”¯çš„æ—¶å€™è§¦å‘CDï¼Œåœ¨github actionsä¸Šç›´æ¥å‘å¸ƒã€‚è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ›´åŠ ä¾¿åˆ©ï¼Œä½†ä¹Ÿä½¿å¾—å­¦ä¹ å†…å®¹å˜å¤šäº†ã€‚

ä¸‹é¢æˆ‘ä»¬å°±è®²è®²CI/CD

## ä½¿ç”¨Github Actions

æŒç»­é›†æˆï¼ˆContinuous Integrationï¼ŒCIï¼‰æ˜¯ä¸€ç§è½¯ä»¶å¼€å‘å®è·µï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹ï¼Œæ¥ç¡®ä¿ä»£ç çš„è´¨é‡å’Œç¨³å®šæ€§ã€‚CIçš„ç›®çš„æ˜¯å°½æ—©å‘ç°å’Œè§£å†³ä»£ç ä¸­çš„é—®é¢˜ï¼Œä»¥ä¾¿å¿«é€Ÿäº¤ä»˜é«˜è´¨é‡çš„è½¯ä»¶ã€‚

åœ¨CIä¸­ï¼Œå¼€å‘è€…å°†ä»£ç æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­ï¼Œç„¶åè‡ªåŠ¨è§¦å‘æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹ã€‚å¦‚æœæ„å»ºæˆ–æµ‹è¯•å¤±è´¥ï¼Œå¼€å‘è€…ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œä»¥ä¾¿åŠæ—¶ä¿®å¤é—®é¢˜ã€‚è¿™æ ·å¯ä»¥é¿å…åœ¨éƒ¨ç½²æ—¶å‡ºç°é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥æé«˜å¼€å‘æ•ˆç‡å’Œè½¯ä»¶è´¨é‡ã€‚

GitHub Actionsï¼ˆåŒç±»äº§å“ CircleCI ã€TravisCIï¼‰æ˜¯GitHubæä¾›çš„ä¸€ç§æŒç»­é›†æˆå’Œéƒ¨ç½²å·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²GitHubä»“åº“ä¸­çš„ä»£ç ã€‚å®ƒä¸GitHubç´§å¯†é›†æˆï¼Œå¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®æ–‡ä»¶æ¥å®šä¹‰å·¥ä½œæµç¨‹ï¼ŒåŒæ—¶æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œæ“ä½œç³»ç»Ÿã€‚

ä½¿ç”¨GitHub Actionsï¼Œå¼€å‘è€…å¯ä»¥è½»æ¾åœ°è®¾ç½®è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•æµç¨‹ï¼Œä»¥ä¾¿åœ¨ä»£ç æäº¤æ—¶è‡ªåŠ¨è¿è¡Œã€‚å®ƒè¿˜æ”¯æŒè‡ªå®šä¹‰ç¯å¢ƒå˜é‡ã€å®šæ—¶è§¦å‘ã€é€šçŸ¥å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒé¡¹ç›®çš„éœ€æ±‚ã€‚

æ€»çš„æ¥è¯´ï¼ŒæŒç»­é›†æˆæ˜¯ä¸€ç§é‡è¦çš„è½¯ä»¶å¼€å‘å®è·µï¼Œå¯ä»¥æé«˜è½¯ä»¶è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚GitHub Actionsæ˜¯ä¸€ç§æ–¹ä¾¿ã€çµæ´»çš„CIå·¥å…·ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²GitHubä»“åº“ä¸­çš„ä»£ç ã€‚

```bash
$ cat .github/workflows/main.yml
name: Node.js CI

on: ["push", "pull_request"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"
      - run: npm install
      - run: npm test
      - run: npm run test:coverage
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          file: ./coverage/lcov.info
```

è¿™é‡Œé¢é¡¶ä¸€ä¸ª2ä¸ªä»»åŠ¡

1ã€Use Node.js

2ã€Upload coverage reports to Codecov

æŸ¥çœ‹actions

![Untitled](img/Untitled%205.png)

æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡ä»£ç æäº¤è§¦å‘çš„ciè®°å½•

![Untitled](img/Untitled%206.png)

## æµ‹è¯•è¦†ç›–ç‡

ä½¿ç”¨c8åšæµ‹è¯•è¦†ç›–ç‡ç”Ÿæˆã€‚

```bash
"scripts": {
 "test:coverage": "c8 tsx --test test/*.ts",
}
```

å¢åŠ é…ç½®.c8rc.jsonï¼Œæ³¨æ„é…ç½®ä¸­çš„reporteré‡Œçš„lcovæ˜¯å¿…é¡»é…ç½®çš„ã€‚

```bash
{
  "reporter": [
    "lcov",
    "text",
    "html"
  ]
}
```

æ‰§è¡Œnpm run test:coverageå°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„æµ‹è¯•è¦†ç›–ç‡æ–‡ä»¶äº†ã€‚

æµ‹è¯•è¦†ç›–ç‡ä¼šæ”¾åœ¨coverageç›®å½•ä¸‹é¢ï¼Œæ‰“å¼€coverage/index.htmlæ–‡ä»¶ã€‚

![Untitled](img/Untitled%207.png)

![Untitled](img/Untitled%208.png)

æµ‹è¯•è¦†ç›–ç‡æ˜¯ä¿è¯æµ‹è¯•æœ‰æ•ˆçš„å¿…å¤‡æ‰‹æ®µã€‚

è¿˜æ˜¯ä»¥ä¹‹å‰çš„ä»£ç ä¸¾ä¾‹

```bash
import { IPerson } from "..";

export class HelloWorld implements IPerson {
  async sayHi(name: string): Promise<void> {
    // è°ƒç”¨Promiseå‡½æ•°
    const text = await this.helloworld(name);
    console.log(text);
  }

  private helloworld(name?: string): Promise<string> {
    return new Promise(function (resolve, reject) {
      if (name) {
        resolve(`Hello ${name}!`);
      } else {
        reject(new Error("fail"));
      }
    });
  }
}
```

å¦‚æœåªæ˜¯æµ‹è¯•sayHiï¼Œä»£ç å¦‚ä¸‹ã€‚

```bash
import { test, describe } from "node:test";
import assert from "node:assert";

import { HelloWorld } from "../src/helloworld";
import { IPerson } from "..";

describe("test suite", function () {
  test("test if works correctly", async function (t) {
    const log = t.mock.method(global.console, "log");

    assert.strictEqual(log.mock.callCount(), 0);
    // call hello world say method
    const cli: IPerson = new HelloWorld();
    await cli.sayHi("liangqi");

    assert.strictEqual(log.mock.callCount(), 1);
  });
});
```

æ­¤æ—¶æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡89.47%

```bash
$ npm run test:coverage

> your-first-nodejs-helloworld-with-ts@1.0.0 test:coverage
> c8 tsx --test test/*.ts

Hello liangqi!
â–¶ test suite
  âœ” test if works correctly (0.864584ms)
â–¶ test suite (1.637167ms)

â„¹ tests 1
â„¹ suites 1
â„¹ pass 1
â„¹ fail 0
â„¹ cancelled 0
â„¹ skipped 0
â„¹ todo 0
â„¹ duration_ms 158.421208
---------------|---------|----------|---------|---------|-------------------
File           | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
---------------|---------|----------|---------|---------|-------------------
All files      |   89.47 |    83.33 |     100 |   89.47 |
 helloworld.ts |   89.47 |    83.33 |     100 |   89.47 | 15-16
---------------|---------|----------|---------|---------|-------------------
```

æ­¤æ—¶æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šï¼Œå…·ä½“å¦‚ä¸‹

![Untitled](img/Untitled%209.png)

éå¸¸æ˜æ˜¾æ˜¯helloworldä¸­çš„elseé€»è¾‘æ²¡æœ‰è¦†ç›–ã€‚

ä¿®æ”¹æµ‹è¯•ä»£ç ï¼Œå¢åŠ ä¸‹é¢çš„ä»£ç ã€‚

```bash
test("test if works incorrectly", async function () {
  const cli: IPerson = new HelloWorld();
  assert.rejects(async () => await cli.sayHi(), new Error("fail"));
});
```

åœ¨æ‰§è¡Œæµ‹è¯•è¦†ç›–ç‡è„šæœ¬ï¼Œæ­¤æ—¶å°±100%äº†ã€‚

## Badge

åœ¨README.mdæ–‡ä»¶ä¸­çš„badgeæ˜¯ä¸€ç§å¾½ç« ï¼Œé€šå¸¸ç”¨äºå±•ç¤ºé¡¹ç›®çš„ä¸€äº›ä¿¡æ¯æˆ–çŠ¶æ€ã€‚å¾½ç« å¯ä»¥æ˜¾ç¤ºé¡¹ç›®çš„æ„å»ºçŠ¶æ€ã€æµ‹è¯•è¦†ç›–ç‡ã€ç‰ˆæœ¬å·ã€è®¸å¯è¯ã€æ”¯æŒçš„å¹³å°ç­‰ç­‰ã€‚è¿™äº›å¾½ç« å¯ä»¥å¸®åŠ©è¯»è€…å¿«é€Ÿäº†è§£é¡¹ç›®çš„ä¸€äº›å…³é”®ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¢åŠ é¡¹ç›®çš„å¯ä¿¡åº¦å’Œå¸å¼•åŠ›ã€‚å¾½ç« é€šå¸¸æ˜¯é€šè¿‡å›¾åƒæˆ–é“¾æ¥çš„å½¢å¼å‘ˆç°åœ¨README.mdæ–‡ä»¶ä¸­ã€‚

ä¾‹å¦‚æˆ‘ä»¬çš„é¡¹ç›®README.mdå±•ç¤ºå¦‚ä¸‹ã€‚

![Untitled](img/Untitled%2010.png)

ç¤ºä¾‹1ï¼šæµ‹è¯•é€šè¿‡

![Untitled](img/Untitled%2011.png)

```tsx
![build status](https://github.com/npmstudy/your-first-nodejs-helloworld-with-ts/actions/workflows/main.yml/badge.svg)
```

ç¤ºä¾‹1ï¼šæµ‹è¯•è¦†ç›–ç‡

![Untitled](img/Untitled%2012.png)

[https://glebbahmutov.com/blog/trying-node-test-runner/#code-coverage](https://glebbahmutov.com/blog/trying-node-test-runner/#code-coverage)

<aside>
ğŸ“¢ è¯¾åç»ƒä¹ ï¼šè‡ªå·±é€šè¿‡github actionsï¼Œåœ¨æ¯æ¬¡mainåˆ†æ”¯è¢«åˆå¹¶ä¹‹åè‡ªåŠ¨å‘npmåŒ…ã€‚

</aside>

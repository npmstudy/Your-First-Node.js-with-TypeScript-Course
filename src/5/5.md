# 5ã€ç»™Node.jsé¡¹ç›®å¢åŠ TSæµ‹è¯•

å¼€å‘ä¸‰å¢ƒç•Œ

1. consoleæ‰“æ—¥å¿—ï¼Œæ— æ•Œ
2. é€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œè¿›é˜¶
3. é€šè¿‡æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œé«˜é˜¶

æ­£å¸¸å¼€å‘æ¥è¯´ï¼ŒæŒæ¡æ–­ç‚¹è°ƒè¯•å·²ç»è¶³å¤Ÿäº†ã€‚æ¯”è¾ƒä¸­è‚¯çš„è¯„ä»·æ˜¯å¤Ÿç”¨ï¼Œä½†ä¸é«˜çº§ã€‚ä½¿ç”¨æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œå…³æ³¨æµ‹è¯•è¦†ç›–ç‡ï¼Œç¡®ä¿åœ¨å·²ç»æµ‹è¯•è¿‡çš„åŠŸèƒ½å‰æä¸‹å¼€å‘æ–°åŠŸèƒ½ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„ä¿è¯è½¯ä»¶è´¨é‡ã€‚

ä½¿ç”¨åœºæ™¯ã€‚

1. å…³æ³¨è´¨é‡çš„åœºæ™¯ï¼Œä¸€èˆ¬æ˜¯å¼€æºé¡¹ç›®ï¼Œå¯å¤ç”¨çš„æ¨¡å—æˆ–ç»„ä»¶ã€‚å˜åŠ¨å¿«çš„é¡¹ç›®å†™æµ‹è¯•ä¼šæ¯”è¾ƒéš¾å—ã€‚
2. ä½¿ç”¨è€…å¿…é¡»æ˜¯æå®¢ï¼Œä¸å–œæ¬¢å­¦ä¹ å’ŒæŠ˜è…¾çš„åŒå­¦ä¸€èˆ¬æ˜¯æä¸å®šçš„ã€‚æ­£å¸¸ç”¨æ³•å¯¹äºä¸€èˆ¬äººæ¥è¯´æå®šå·²ç»ä¸å®¹æ˜“äº†ã€‚è€Œæµ‹è¯•æ˜¯éµå¾ªå¼€é—­åŸåˆ™ï¼Œå‡†å¤‡æµ‹è¯•å°±éœ€è¦æŠŠä¸å¸¸ç”¨çš„æ–¹æ³•ä¹Ÿå†™åœ¨æµ‹è¯•ç”¨ä¾‹ï¼Œæ¯”å¦‚æ­£å¸¸åˆ›å»ºæ–‡ä»¶ï¼Œæµ‹è¯•ç”¨ä¾‹å°±éœ€è¦å†™åˆ é™¤æ–‡ä»¶ä½œä¸ºæ¨¡æ‹Ÿã€‚

æµ‹è¯•å…¶å®ä¹Ÿä¸éš¾ï¼Œå¦‚æœå¤§å®¶åœ¨æŒæ¡åŸºç¡€æœ‰ä½™åŠ›çš„æƒ…å†µä¸‹ï¼Œæ˜¯å¯ä»¥å­¦ä¹ ä¸€ä¸‹ã€‚

# å¢åŠ TSæµ‹è¯•

å¢åŠ jsæµ‹è¯•å’Œå¢åŠ tsæµ‹è¯•æ²¡æœ‰æœ¬ç« åŒºåˆ«ï¼Œåœ¨æµ‹è¯•æ¡†æ¶ç”¨æ³•ä¸Šæ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€å¢åŠ çš„å°±æ˜¯tså¼•å…¥ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–åšç±»å‹æµ‹è¯•ã€‚

<aside>
ğŸ’¡ è‡ªåŠ¨åŒ–æµ‹è¯•èƒ½å¤Ÿé¢„é˜²æ— æ„å¼•å…¥çš„ bugï¼Œå¹¶é¼“åŠ±å¼€å‘è€…å°†åº”ç”¨åˆ†è§£ä¸ºå¯æµ‹è¯•ã€å¯ç»´æŠ¤çš„å‡½æ•°ã€æ¨¡å—ã€ç±»å’Œç»„ä»¶ã€‚

</aside>

## ä½¿ç”¨Node.jså†…ç½®æµ‹è¯•æ¡†æ¶

Node.jsè¯ç”Ÿè‡ª2009å¹´ï¼Œåœ¨v18ä¹‹å‰çš„13å¹´æ—¶é—´é‡Œéƒ½æ²¡æœ‰å†…ç½®ä»»ä½•æµ‹è¯•æ¡†æ¶ã€‚ä¸€ç›´éƒ½æ˜¯ä½¿ç”¨npmç”Ÿæ€ã€‚åƒç‹¼ä¹¦ç³»åˆ—å·ä¸‰ä¸­æåˆ°çš„å‡ ä¸ªæµ‹è¯•æ¡†æ¶ï¼Œéƒ½å·²ç»æœ‰5å¹´ä»¥ä¸Šçš„å†å²äº†ã€‚

| æµ‹è¯•**æ¡†æ¶** | å½“å‰ä¸»è¦ç‰ˆæœ¬ | å¹´é™ |
| --- | --- | --- |
| mocha | v10 | 11 |
| tap | v16 | 11 |
| tape | v5 | 10 |
| ava | v5 | 9 |
| jest | v27 | 7 |

Node.jséµå¾ªä¸JavaScriptæœ¬èº«ç›¸åŒçš„"æœ€å°æ ¸å¿ƒ"åŸåˆ™ã€‚å› æ­¤ï¼Œåƒä»£ç æ£€æŸ¥å·¥å…·ã€ä»£ç æ ¼å¼åŒ–å·¥å…·å’Œæµ‹è¯•è¿è¡Œå™¨è¿™æ ·çš„å·¥å…·æœ€å¥½ä½œä¸ºç¬¬ä¸‰æ–¹å·¥å…·æä¾›ã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æƒ³æ³•å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œä½†ç°åœ¨æ²¡æœ‰æ ‡å‡†æµ‹è¯•å·¥å…·çš„ä»»ä½•è¯­è¨€éƒ½æ˜¾å¾—æœ‰äº›å¥‡æ€ªã€‚Denoã€Rustå’ŒGo - å®ƒä»¬éƒ½æœ‰è‡ªå·±å†…ç½®çš„æµ‹è¯•è¿è¡Œå™¨ã€‚

ç›®å‰å„ä¸ªæµ‹è¯•æ¡†æ¶å’ŒNode.jså†…ç½®æµ‹è¯•æ¡†æ¶å·®å¼‚å¯¹æ¯”å¦‚ä¸‹ï¼Œå‚è€ƒè‡ª[https://glebbahmutov.com/blog/trying-node-test-runner/](https://glebbahmutov.com/blog/trying-node-test-runner/)ã€‚

| ç‰¹æ€§ | **Mocha** | **Ava** | **Jest** | **Node.js TR** | æ¨è |
| --- | --- | --- | --- | --- | --- |
| å†…ç½®åœ¨Nodeä¸­ | ğŸš« | ğŸš« | ğŸš« | âœ… | ğŸ‰ |
| Watch æ¨¡å¼ | âœ… | âœ… | âœ… | âœ… | ğŸ‰ |
| Reporters | lots | via TAP | lots | via TAP |  |
| Assertions | via Chai âœ… | âœ… | âœ… | weak | ğŸ˜‘ |
| Snapshots | ğŸš« | âœ… | âœ… | ğŸš« |  |
| Hooks | âœ… | âœ… | âœ… | âœ… |  |
| grep support | âœ… | âœ… | âœ… | âœ… |  |
| spy and stub | via Sinon âœ… | via Sinon âœ… | âœ…âœ… | âœ… |  |
| parallel execution | âœ… | âœ… | âœ… | âœ… |  |
| code coverage | via nyc | via c8 | âœ… | âœ… | ğŸ‘ |
| TS support | via ts-node | via ts-node | via ts-jest | via ts-node | ğŸ¢ |

åœ¨Node.js v18å¼€å§‹å†…ç½®äº†æµ‹è¯•æ¡†æ¶ï¼Œåœ¨Node.js v20ç‰ˆæœ¬ä¸­ï¼Œå·²ç»è¢«æ ‡è®°ä¸ºStableèƒ½åŠ›ï¼Œå¤§å®¶å¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚

```bash
import {test, describe} from 'node:test';
import assert from 'node:assert';

import { HelloWorld } from "./helloworld.mjs";

describe("test suite", function() {
 test("test if works correctly", function() {
   // run some test
   assert.strictEqual(1, 1);
 })
})
```

æ­¤æ—¶ï¼Œæ‰§è¡Œnpm testæˆ–node â€”test â€”watchå°±å¯ä»¥äº†ã€‚

```bash
$ npm test

> node20@1.0.0 test
> node --watch --test .

â–¶ test suite
  âœ” test if works correctly (0.104958ms)
â–¶ test suite (0.894917ms)
```

## ä½¿ç”¨Tsdç±»å‹æµ‹è¯•

å†™äº†ç±»å‹ï¼Œæœ€å¥½å†™å¥½ç±»å‹æµ‹è¯•ï¼Œåœ¨tsç”Ÿæ€é‡Œï¼Œå¯ä»¥ä½¿ç”¨tsdæ¥åšç±»å‹æµ‹è¯•ã€‚

åˆ›å»ºindex.test-d.tsæ–‡ä»¶

```bash
import { expectType } from "tsd";

import { IPerson } from ".";
import { HelloWorld } from "./src/helloworld";

const cli: IPerson = new HelloWorld();

expectType<Promise<void>>(cli.sayHi("use TypeScript to write Node.js"));
```

æ‰§è¡Œ

```bash
$ npx tsd
```

å¦‚æœæ²¡æœ‰ä»»ä½•æ˜¾ç¤ºï¼Œè¯´æ˜æµ‹è¯•é€šè¿‡ã€‚å¦‚æœæœ‰é”™è¯¯å°±ä¼šæœ‰ä¸‹é¢è¿™æ ·çš„æ˜¾ç¤ºã€‚

![Untitled](img/Untitled.png)

å†æ€è€ƒä¸€ä¸‹

- æœ‰ä»£ç ï¼Œå°±è¦æµ‹è¯•
- æœ‰ç±»å‹ï¼Œå°±è¦æœ‰ç±»å‹æµ‹è¯•

å¦‚æœæƒ³è§„èŒƒçš„å†™ï¼Œå°±ä¼šæ¯”è¾ƒéº»çƒ¦ä¸€ç‚¹ã€‚å¦‚æœä»€ä¹ˆéƒ½ä¸å†™ï¼Œä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œåªæ˜¯ä¸æ ‡å‡†è€Œå·²ã€‚åƒRailsè¿™ç§è¿½æ±‚æè‡´æ•ˆç‡ï¼Œåˆæƒ³æ ‡å‡†çš„é¡¹ç›®ï¼Œä¸ç”¨tsæ˜¯æ­£å¸¸çš„ã€‚

## æ·»åŠ TSæµ‹è¯•

è¿™æ ·çš„æè¿°è¢«ç§°ä½œÂ **è§„èŒƒï¼ˆspecification, specï¼‰**ï¼ŒåŒ…å«ç”¨ä¾‹çš„æè¿°ä»¥åŠé’ˆå¯¹å®ƒä»¬çš„æµ‹è¯•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```bash
import { it, describe } from "node:test";
import assert from "node:assert";

import { HelloWorld } from "../src/helloworld";
import { IPerson } from "..";

describe("test suite", function () {
  it("test if works correctly", async function (t) {
    const log = t.mock.method(global.console, "log");

    assert.strictEqual(log.mock.callCount(), 0);
    // call hello world say method
    const cli: IPerson = new HelloWorld();
    await cli.sayHi("liangqi");

    assert.strictEqual(log.mock.callCount(), 1);
  });

  it("test if works incorrectly", async function () {
    const cli: IPerson = new HelloWorld();
    assert.rejects(async () => await cli.sayHi(), new Error("fail"));
  });
});
```

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä¸€ä¸ªè§„èŒƒåŒ…å«ä¸‰ä¸ªä¸»è¦çš„æ¨¡å—ï¼š

1ã€**`describe("title", function() { ... })`**è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨æè¿°çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Œç›¸å½“äºä¸€ä¸ªgroupã€‚ç”¨äºç»„ç»‡â€œå·¥äººï¼ˆworkersï¼‰â€ â€”â€”Â `it`Â ä»£ç å—ã€‚

2ã€**`it("use case description", function() { ... })**it`Â é‡Œé¢çš„æè¿°éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä»¥ä¸€ç§Â **æ˜“äºç†è§£**Â çš„æ–¹å¼æè¿°ç‰¹å®šçš„ç”¨ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨äºå¯¹å…¶è¿›è¡Œæµ‹è¯•çš„å‡½æ•°ã€‚è¡¨ç¤ºè¿™æ˜¯"ä¸€ç³»åˆ—æµ‹è¯•"ä¸­çš„ä¸€é¡¹ï¼Œç›¸å½“äºitemï¼Œå¦‚ä½•æµ‹è¯•ï¼Ÿæµ‹è¯•é€»è¾‘ï¼Ÿéƒ½æ˜¯åœ¨itçš„å›è°ƒå‡½æ•°ä¸­å®ç°çš„

3ã€**`assert.equal(value1, value2)**it`Â å—ä¸­çš„ä»£ç ï¼Œå¦‚æœå®ç°æ˜¯æ­£ç¡®çš„ï¼Œå®ƒåº”è¯¥åœ¨æ‰§è¡Œçš„æ—¶å€™ä¸äº§ç”Ÿä»»ä½•é”™è¯¯ã€‚
`assert.*`Â å‡½æ•°ç”¨äºæ£€æŸ¥Â æµ‹è¯•Â å‡½æ•°æ˜¯å¦æŒ‰ç…§é¢„æœŸå·¥ä½œã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†å…¶ä¸­ä¹‹ä¸€ â€”â€”Â `assert.equal`ï¼Œå®ƒä¼šå¯¹å‚æ•°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå®ƒä»¬ä¸ç›¸ç­‰åˆ™ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚è¿™é‡Œå®ƒæ£€æŸ¥äº†Â `pow(2, 3)`Â çš„å€¼æ˜¯å¦ç­‰äºÂ `8`ã€‚è¿˜æœ‰å…¶ä»–ç±»å‹çš„æ¯”è¾ƒå’Œæ£€æŸ¥ï¼Œæˆ‘ä»¬å°†åœ¨åé¢ä»‹ç»åˆ°ã€‚

è§„èŒƒå¯ä»¥è¢«æ‰§è¡Œï¼Œå®ƒå°†è¿è¡Œåœ¨Â `it`Â å—ä¸­æŒ‡å®šçš„æµ‹è¯•ã€‚æˆ‘ä»¬ç¨åä¼šçœ‹åˆ°ã€‚

å¼€å‘æµç¨‹é€šå¸¸çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

1. ç¼–å†™åˆå§‹è§„èŒƒï¼Œæµ‹è¯•æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚
2. åˆ›å»ºä¸€ä¸ªæœ€åˆå§‹çš„å®ç°ã€‚
3. æ£€æŸ¥å®ƒæ˜¯å¦å·¥ä½œï¼Œæˆ‘ä»¬è¿è¡Œæµ‹è¯•æ¡†æ¶ï¼ˆå¾ˆå¿«ä¼šæœ‰æ›´å¤šç»†èŠ‚ï¼‰æ¥è¿è¡Œæµ‹è¯•ã€‚å½“åŠŸèƒ½æœªå®Œæˆæ—¶ï¼Œå°†æ˜¾ç¤ºé”™è¯¯ã€‚æˆ‘ä»¬æŒç»­ä¿®æ­£ç›´åˆ°ä¸€åˆ‡éƒ½èƒ½å·¥ä½œã€‚
4. ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰æµ‹è¯•çš„èƒ½å·¥ä½œçš„åˆæ­¥å®ç°ã€‚
5. æˆ‘ä»¬å¢åŠ æ›´å¤šçš„ç”¨ä¾‹åˆ°è§„èŒƒä¸­ï¼Œæˆ–è®¸ç›®å‰çš„ç¨‹åºå®ç°è¿˜ä¸æ”¯æŒã€‚æ— æ³•é€šè¿‡æµ‹è¯•ã€‚
6. å›åˆ°ç¬¬ 3 æ­¥ï¼Œæ›´æ–°ç¨‹åºç›´åˆ°æµ‹è¯•ä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚
7. é‡å¤ç¬¬ 3 æ­¥åˆ°ç¬¬ 6 æ­¥ï¼Œç›´åˆ°åŠŸèƒ½å®Œå–„ã€‚

å¦‚æ­¤æ¥çœ‹ï¼Œå¼€å‘å°±æ˜¯ä¸æ–­åœ°Â **è¿­ä»£**ã€‚æˆ‘ä»¬å†™è§„èŒƒï¼Œå®ç°å®ƒï¼Œç¡®ä¿æµ‹è¯•é€šè¿‡ï¼Œç„¶åå†™æ›´å¤šçš„æµ‹è¯•ï¼Œç¡®ä¿å®ƒä»¬å·¥ä½œç­‰ç­‰ã€‚æœ€åï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªèƒ½å·¥ä½œçš„å®ç°å’Œé’ˆå¯¹å®ƒçš„æµ‹è¯•ã€‚

è®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„å¼€å‘æ¡ˆä¾‹ä¸­çœ‹çœ‹è¿™ä¸ªå¼€å‘æµç¨‹å§ã€‚

åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œç¬¬ä¸€æ­¥å·²ç»å®Œæˆäº†ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ªé’ˆå¯¹Â helloworldÂ çš„åˆå§‹è§„èŒƒã€‚å› æ­¤è®©æˆ‘ä»¬æ¥å®ç°å®ƒå§ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç”¨ä¸€äº› JavaScript åº“æ¥è¿è¡Œæµ‹è¯•ï¼Œå°±æ˜¯çœ‹çœ‹æµ‹è¯•æ˜¯é€šè¿‡äº†è¿˜æ˜¯å¤±è´¥äº†ã€‚

# å¸¸ç”¨æµ‹è¯•æŠ€å·§è¿›é˜¶

## åŒæ­¥å’Œå¼‚æ­¥

```tsx

describe("test suite", function () {
  it.only("test if works correctly", async function (t) {

  }
})

test('callback passing test', (t, done) => {
  // done() is the callback function. When the setImmediate() runs, it is'k'i'lnvokes
  // done() with no arguments.
  setImmediate(done);
});
```

## å¸¸ç”¨æŠ€å·§

Exclusive && Inclusiveå…¶å®å¾ˆå¥½ç†è§£ï¼Œåˆ†åˆ«å¯¹åº”onlyå’Œskipå‡½æ•°ã€‚è¿™æ˜¯åªæœ‰å†™çš„test caseæ¯”è¾ƒå¤šçš„æ—¶å€™æ‰ä¼šç”¨çš„ç®€å•æŠ€å·§ã€‚(ä¸‹é¢ä»£ç æ—¶æ­£å¸¸å†™æ³•ï¼Œä½†åœ¨Node.js v20ä¹Ÿæ˜¯ç›´æ¥è¿è¡Œ)

```tsx
import { it, describe } from "node:test";
import assert from "node:assert";

import { HelloWorld } from "../src/helloworld";
import { IPerson } from "..";

describe("test suite", function () {
  it.only("test if works correctly", async function (t) {
    const log = t.mock.method(global.console, "log");

    assert.strictEqual(log.mock.callCount(), 0);
    // call hello world say method
    const cli: IPerson = new HelloWorld();
    await cli.sayHi("liangqi");

    assert.strictEqual(log.mock.callCount(), 1);
  });

  it.skip("test if works incorrectly", async function () {
    const cli: IPerson = new HelloWorld();
    assert.rejects(async () => await cli.sayHi(), new Error("fail"));
  });
});

```

ä¸Šé¢çš„ä»£ç åªä¼šæœ‰ä¸€ä¸ªtest completeï¼Œ åªæœ‰onlyçš„ä¼šè¢«æ‰§è¡Œï¼Œå¦ä¸€ä¸ªä¼šè¢«å¿½ç•¥æ‰ã€‚æ¯ä¸ªå‡½æ•°é‡Œåªèƒ½æœ‰ä¸€ä¸ªonlyã€‚å¦‚æœæ˜¯it.skip ï¼Œé‚£ä¹ˆè¯¥caseå°±ä¼šè¢«å¿½ç•¥ã€‚onlyå’Œskipå…±ç”¨æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå› ä¸ºonlyçš„ä½œç”¨ä¼šæŠŠskipå±è”½æ‰ã€‚

å®é™…ä¸Šï¼ŒNode.js v20é‡Œæ²¡æœ‰æŒ‰ç…§å¸¸è§„çš„å†™æ³•ï¼Œè€Œæ˜¯é‡‡ç”¨äº†é…ç½®å‚æ•°ç»“åˆcliçš„æ–¹å¼ã€‚

skip

```tsx
// The skip option is used, but no message is provided.
test('skip option', { skip: true }, (t) => {
  // This code is never executed.
});

// The skip option is used, and a message is provided.
test('skip option with message', { skip: 'this is skipped' }, (t) => {
  // This code is never executed.
});

test('skip() method', (t) => {
  // Make sure to return here as well if the test contains additional logic.
  t.skip();
});

test('skip() method with message', (t) => {
  // Make sure to return here as well if the test contains additional logic.
  t.skip('this is skipped');
});
```

only

```tsx
// Assume Node.js is run with the --test-only command-line option.
// The 'only' option is set, so this test is run.
test('this test is run', { only: true }, async (t) => {
  // Within this test, all subtests are run by default.
  await t.test('running subtest');

  // The test context can be updated to run subtests with the 'only' option.
  t.runOnly(true);
  await t.test('this subtest is now skipped');
  await t.test('this subtest is run', { only: true });

  // Switch the context back to execute all tests.
  t.runOnly(false);
  await t.test('this subtest is now run');

  // Explicitly do not run these tests.
  await t.test('skipped subtest 3', { only: false });
  await t.test('skipped subtest 4', { skip: true });
});

// The 'only' option is not set, so this test is skipped.
test('this test is not run', () => {
  // This code is not run.
  throw new Error('fail');
});
```

å‚è€ƒAPIæ–‡æ¡£[https://nodejs.org/api/test.html#testskipname-options-fn](https://nodejs.org/api/test.html#testskipname-options-fn)

![Untitled](img/Untitled%201.png)

æœ‰æ„æ€çš„æ˜¯å®ƒç«Ÿç„¶åŠ äº†**`todo`**è¿™ä¸ªæµ‹è¯•ï¼Œæ˜¯ä¸€ä¸ªTODOçš„ç®€å†™ã€‚

## ç”Ÿå‘½å‘¨æœŸ

ç»†å¿ƒçš„è¯»è€…åº”è¯¥å‘ç°äº†æˆ‘ä»¬æ¯æ¬¡åœ¨å•å…ƒæµ‹è¯•å¼€å§‹å’Œç»“æŸå‰éƒ½éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œè¦ä¹ˆæ˜¯stubå‡½æ•°ï¼Œè¦ä¹ˆæ˜¯å‡†å¤‡mockæ•°æ®ã€‚æµ‹è¯•æ¡†æ¶æä¾›äº†å››ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›å¯ä»¥å¤ç”¨çš„å‡†å¤‡å·¥ä½œæ”¾åˆ°é’©å­ä¸­å»ï¼š

```tsx
describe('test', function() {
  // åœ¨æœ¬æµ‹è¯•å—çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¹‹å‰æ‰§è¡Œä¸”ä»…æ‰§è¡Œä¸€æ¬¡
  before(function() {

  });
  // åœ¨æœ¬æµ‹è¯•å—çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¹‹åæ‰§è¡Œä¸”ä»…æ‰§è¡Œä¸€æ¬¡
  after(function() {

  });

  // åœ¨æµ‹è¯•å—çš„æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¹‹å‰æ‰§è¡Œï¼ˆæœ‰å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹itï¼Œå°±æ‰§è¡Œå‡ æ¬¡ï¼‰
  beforeEach(function() {

  });
  // åœ¨æµ‹è¯•å—çš„æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¹‹åæ‰§è¡Œï¼ˆåŒä¸Šï¼‰
  afterEach(function() {

  });

  // æµ‹è¯•ç”¨ä¾‹
  it('test item1', function () {

  })
});
```

åœ¨ä¸‹ä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨å†™ä¸€ä¸ªHttp Serveræµ‹è¯•çš„æ—¶å€™å°±ä¼šç”¨åˆ°è¯¥çŸ¥è¯†ç‚¹ï¼Œéœ€è¦åœ¨beforeé‡Œå…ˆå¯åŠ¨æœåŠ¡ï¼Œç„¶åå†å»è·‘æµ‹è¯•ç”¨ä¾‹ã€‚

## TDD vs BDD

BDDï¼ˆBehaviour Driven Developmentï¼‰æ˜¯TDDçš„ä¸€ç§ï¼Œ å€¾å‘äºæ–­è¨€è¢«æµ‹å¯¹è±¡çš„è¡Œä¸ºç‰¹å¾è€Œéè¾“å…¥è¾“å‡ºã€‚Â [Chai](http://chaijs.com/)çš„BDDé£æ ¼æ–­è¨€åº“åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š`expect`å’Œ`should`ã€‚=

å‰é¢æ‰€è®²çš„describe, it, before, afterç­‰éƒ½å±äºBDDçš„èŒƒç•´ï¼Œå¯¹äºTDDï¼ŒMochaã€Avaç­‰æµ‹è¯•åº“éƒ½ç”¨suite, test, setup, teardownã€‚

```tsx
suite 'Array', !->
    setup !->
        console.log 'setup'
    teardown !->
        console.log 'teardown'
    suite '#indexOf()', !->
        test 'should return -1 when not present', !->
            assert.equal -1, [1,2,3].indexOf 4
```

TDDæ˜¯æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Developmentï¼‰çš„ç¼©å†™ã€‚è¯•é©±åŠ¨å¼€å‘æ˜¯ä¸€ç§è½¯ä»¶å¼€å‘æ–¹æ³•è®ºï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç¼–å†™å®é™…ä»£ç ä¹‹å‰ï¼Œå…ˆç¼–å†™æµ‹è¯•ä»£ç ã€‚

å…·ä½“çš„å¼€å‘æµç¨‹å¦‚ä¸‹ï¼š

1. ç¼–å†™æµ‹è¯•ï¼šé¦–å…ˆï¼Œå¼€å‘äººå‘˜ç¼–å†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæè¿°äº†é¢„æœŸçš„åŠŸèƒ½å’Œè¡Œä¸ºã€‚è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹ä¼šå¤±è´¥ï¼Œå› ä¸ºå®é™…çš„ä»£ç å°šæœªç¼–å†™ã€‚
2. è¿è¡Œæµ‹è¯•ï¼šè¿è¡Œç¼–å†™çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®è®¤æµ‹è¯•å¤±è´¥ã€‚
3. ç¼–å†™ä»£ç ï¼šæ¥ä¸‹æ¥ï¼Œå¼€å‘äººå‘˜ç¼–å†™è¶³å¤Ÿçš„ä»£ç æ¥æ»¡è¶³æµ‹è¯•ç”¨ä¾‹çš„è¦æ±‚ã€‚
4. è¿è¡Œæµ‹è¯•ï¼šå†æ¬¡è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œç¡®è®¤æµ‹è¯•é€šè¿‡ã€‚
5. é‡æ„ä»£ç ï¼šå¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå¼€å‘äººå‘˜å¯ä»¥å¯¹ä»£ç è¿›è¡Œé‡æ„ï¼Œä»¥æé«˜ä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚
6. é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼šé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç¼–å†™ä¸‹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶æŒ‰ç…§ç›¸åŒçš„æµç¨‹ç¼–å†™ä»£ç ï¼Œç›´åˆ°å®ç°æ‰€éœ€çš„åŠŸèƒ½ã€‚

æµ‹è¯•é©±åŠ¨å¼€å‘çš„ä¼˜åŠ¿åœ¨äºå®ƒå¼ºè°ƒäº†æµ‹è¯•çš„é‡è¦æ€§ï¼Œå¹¶ä¿ƒä½¿å¼€å‘äººå‘˜åœ¨ç¼–å†™ä»£ç ä¹‹å‰å°±æ€è€ƒå’Œå®šä¹‰ä»£ç çš„è¡Œä¸ºã€‚è¿™æœ‰åŠ©äºæé«˜ä»£ç è´¨é‡ã€å‡å°‘bugï¼Œå¹¶ä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚æ­¤å¤–ï¼Œæµ‹è¯•é©±åŠ¨å¼€å‘è¿˜å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œå› ä¸ºé€šè¿‡æµ‹è¯•ç”¨ä¾‹å¯ä»¥æ›´æ—©åœ°å‘ç°é—®é¢˜ï¼Œå¹¶åŠæ—¶è¿›è¡Œä¿®å¤ã€‚

é‡ç‚¹å›é¡¾ï¼š

- å…ˆå†™æµ‹è¯•å†å¼€å‘ã€‚
- ä¾å¾ªã€Œçº¢ç¯ï¼ç»¿ç¯ï¼é‡æ„ã€å¾ªç¯ï¼ˆRed/Green/Refactorï¼‰ã€‚
- ä¼˜ç‚¹æ˜¯åœ¨åˆæœŸå°±ç¡®ä¿æµ‹è¯•ç¨‹åºçš„æ’°å†™ï¼Œè€Œä¸”æ›´å®¹æ˜“åœ¨åˆæœŸå®šä¹‰å‡ºæ›´è´´è¿‘ä½¿ç”¨æ–¹çš„æ¥å£ã€‚

ä½† TDD æ‰€æ’°å†™å‡ºæ¥çš„æµ‹è¯•æ¡ˆä¾‹æ˜¯ä¸€è¿ä¸²ç¨‹å¼ç ï¼Œè¿‡äºåé‡æŠ€æœ¯äººå‘˜ï¼Œä¸åˆ©ä¸å…¶ä»–éæŠ€æœ¯çš„é¡¹ç›®å‚ä¸è€…è®¨è®ºï¼Œä¾‹å¦‚ PM (Product Manager) æˆ– PO (Product Owner)ã€‚æ­¤å¤–ï¼Œä¹Ÿä¸åˆ©äº§ç”Ÿä¸€ä»½å¦‚ä¸‹å›¾è¿™æ ·ä¸€ç›®äº†ç„¶ã€å®¹æ˜“é˜…è¯»çš„æµ‹è¯•æŠ¥å‘Šã€‚

TDDæ›´å¤šçš„æ˜¯æ–¹æ³•è®ºï¼ŒæŒ‡å¯¼ä»£ç ç¼–å†™æ–¹å¼ç”¨çš„ã€‚è¿™å—å¯ä»¥è®²çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œå»ºè®®å¤§å®¶å»å­¦ä¹ ä¸€ä¸‹æ•æ·å¼€å‘ï¼Œæ¥ä½œä¸ºè¡¥å……ã€‚

## Spy & Mock & Stub

åœ¨è½¯ä»¶æµ‹è¯•ä¸­ï¼Œstubã€mock å’Œ spy æ˜¯ä¸‰ç§ç”¨äºæ¨¡æ‹Ÿå’Œæµ‹è¯•ä¾èµ–å…³ç³»çš„æŠ€æœ¯ã€‚

- Stub **ï¼ˆæ’æ¡©ï¼‰**æ˜¯ä¸€ç§ç”¨äºåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­æ›¿æ¢å¤–éƒ¨ä¾èµ–çš„æŠ€æœ¯ã€‚å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†åœ¨æµ‹è¯•ä¸­æä¾›æ‰€éœ€çš„è¾“å…¥ï¼Œå¹¶é˜»æ­¢å®é™…çš„ä¾èµ–ä»£ç è¢«æ‰§è¡Œã€‚è¿™æ ·ï¼Œå°±å¯ä»¥å¯¹ä»£ç è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œè€Œæ— éœ€è€ƒè™‘å¤–éƒ¨ä¾èµ–çš„å½±å“ã€‚
- Mock **ï¼ˆä¼ªé€ ï¼‰**æ˜¯ä¸€ç§ç”¨äºåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­æ¨¡æ‹Ÿä¾èµ–å…³ç³»çš„æŠ€æœ¯ã€‚å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†æµ‹è¯•ä»£ç çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯å®é™…çš„ç»“æœã€‚é€šå¸¸ï¼Œmock ä¼šè·Ÿè¸ªä¾èµ–ä»£ç çš„è°ƒç”¨æ¬¡æ•°å’Œå‚æ•°ï¼Œå¹¶æ ¹æ®é¢„æœŸçš„è¡Œä¸ºç»™å‡ºå“åº”ã€‚
- Spyï¼ˆ**é—´è°**ï¼‰ æ˜¯ä¸€ç§ç”¨äºåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ç›‘è§†ä¾èµ–å…³ç³»çš„æŠ€æœ¯ã€‚å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†æµ‹è¯•ä¾èµ–ä»£ç çš„å®é™…è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯å®ƒçš„è¿”å›å€¼ã€‚é€šå¸¸ï¼Œspy ä¼šè·Ÿè¸ªä¾èµ–ä»£ç çš„è°ƒç”¨æ¬¡æ•°å’Œå‚æ•°ï¼Œå¹¶è®°å½•ä¸‹å®é™…æ‰§è¡Œçš„è¡Œä¸ºã€‚

æ€»çš„æ¥è¯´ï¼Œstub å’Œ mock çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†åœ¨æµ‹è¯•ä¸­æ›¿æ¢ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯ mock æ›´åŠ å¼ºè°ƒå¯¹ä»£ç è¡Œä¸ºçš„æµ‹è¯•ï¼Œè€Œ stub æ›´åŠ å¼ºè°ƒæä¾›æµ‹è¯•æ‰€éœ€çš„è¾“å…¥ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œspy çš„ç›®çš„æ˜¯ä¸ºäº†ç›‘è§†ä¾èµ–å…³ç³»çš„ã€‚

åœ¨Node.js v20ä¸­ï¼Œstubå’Œspyéƒ½å¯ä»¥é€šè¿‡mockæ¥å®ç°ã€‚

1ã€mockç¤ºä¾‹

```tsx
'use strict';
const assert = require('node:assert');
const { mock, test } = require('node:test');

test('spies on a function', () => {
  const sum = mock.fn((a, b) => {
    return a + b;
  });

  assert.strictEqual(sum.mock.calls.length, 0);
  assert.strictEqual(sum(3, 4), 7);
  assert.strictEqual(sum.mock.calls.length, 1);

  const call = sum.mock.calls[0];
  assert.deepStrictEqual(call.arguments, [3, 4]);
  assert.strictEqual(call.result, 7);
  assert.strictEqual(call.error, undefined);

  // Reset the globally tracked mocks.
  mock.reset();
});
```

2ã€spyç¤ºä¾‹

```tsx
import {
  describe,
  it,
  mock
} from 'node:test'
import assert from 'node:assert'

function run({ fn, times }) {
  for (let i = 0; i < times; i++) {
    fn({ current: i * 5 })
  }
}

describe('Spies Test Suite', () => {
  it('should verify calls in a mock', () => {
    const spy = mock.fn()
    run({ fn: spy, times: 2 })

    assert.strictEqual(spy.mock.callCount(), 2)
    const calls = spy.mock.calls
    assert.deepStrictEqual(calls[0].arguments[0], { current: 0 })
    assert.deepStrictEqual(calls[1].arguments[0], { current: 5 })
  })
})
```

3ã€stubç¤ºä¾‹

```tsx
import {
  describe,
  it,
  beforeEach,
  mock
} from 'node:test'
import assert from 'node:assert'

class Service {
  static async getTalks({ skip, limit }) {
    const items = await fetch('https://tml-api.herokuapp.com/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        query: `
        {
          getTalks (skip: ${skip}, limit: ${limit}) {
            totalCount,
            talks {
              _id
              title
            }
          }
        }
        `
      })
    })
    return (await items.json()).data.getTalks.talks
  }
}

function mapResponse(data) {
  return data
    .map(({ _id, title }, index) => `[${index}] id: ${_id}, title: ${title}`)
    .join('\n')
}

async function run({ skip = 0, limit = 10 }) {
  const talks = mapResponse(await Service.getTalks({ skip, limit }))
  return talks
}

describe('Stub Test Suite', () => {
  // only needed if you're not using the context variable
  // in the it() calls
  beforeEach(() => mock.restoreAll())

  it('should stub APIs', async (context) => {
    context.mock.method(
      Service,
      Service.getTalks.name,
    ).mock.mockImplementation(async () => [
      {
        _id: '63865750c839dbaacd8116e1',
        title: 'The Journey About How I Fixed a Bug in the Node.js Core That Affected Thousands of Packages'
      }
    ])

    const result = await run({ limit: 1 })
    const expected = `[0] id: 63865750c839dbaacd8116e1, title: The Journey About How I Fixed a Bug in the Node.js Core That Affected Thousands of Packages`

    assert.deepStrictEqual(Service.getTalks.mock.callCount(), 1)
    const calls = Service.getTalks.mock.calls

    assert.deepStrictEqual(calls[0].arguments[0], { skip: 0, limit: 1 })
    assert.strictEqual(result, expected)
  })
})
```

## Chaijsæ›´å¥½çš„æ–­è¨€åº“

Chaiæ˜¯ä¸€ä¸ªJavaScriptçš„æ–­è¨€åº“ï¼Œç”¨äºç¼–å†™å¯è¯»æ€§å¼ºçš„æµ‹è¯•ä»£ç ã€‚å®ƒæä¾›äº†ä¸€ç»„æ˜“äºä½¿ç”¨çš„æ–­è¨€æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜ç¼–å†™æ¸…æ™°ã€ç®€æ´çš„æµ‹è¯•æ–­è¨€ã€‚

Chaiå¯ä»¥ä¸å„ç§æµ‹è¯•æ¡†æ¶ï¼ˆå¦‚Mochaã€Jasmineç­‰ï¼‰é…åˆä½¿ç”¨ï¼Œä½¿å¾—ç¼–å†™å’Œè¿è¡ŒJavaScriptæµ‹è¯•å˜å¾—æ›´åŠ å®¹æ˜“å’Œé«˜æ•ˆã€‚

![Untitled](img/Untitled%202.png)

BDDé£æ ¼æœ‰ä¸¤ç§é£æ ¼ï¼šexpectå’Œshouldã€‚ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„å¯é“¾æ¥è¯­è¨€æ¥æ„é€ æ–­è¨€ï¼Œä½†å®ƒä»¬åœ¨æœ€åˆæ„é€ æ–­è¨€çš„æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒã€‚åœ¨ä½¿ç”¨shouldçš„æƒ…å†µä¸‹å°†å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ï¼Œè¿™ä¹Ÿæœ‰ä¸€äº›æ–¹å¼å»å…‹æœè¿™äº›é—®é¢˜ã€‚

**Expect**

 BDDé£æ ¼æš´éœ²expectæˆ–shouldæ¥å£ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€çš„å½¢å¼æ¥é“¾æ¥æ–­è¨€ã€‚ Expectä¹Ÿå…è®¸ä½ åœ¨ä»»ä½•å¯èƒ½å‘ç”Ÿçš„æ–­è¨€å¤±è´¥ä¹‹å‰æ·»åŠ ä»»æ„ä¿¡æ¯ã€‚å½“ä¸å¸ƒå°”å€¼ã€æ•°å­—ç­‰éæè¿°æ€§ä¸»é¢˜ä¸€èµ·è¿ç”¨æ—¶ï¼Œè¿™å°†ååˆ†å¥½ç”¨ã€‚

**Should**

Shouldå…è®¸ä½ ä½¿ç”¨ä¸Expectæ¥å£ç›¸åŒçš„é“¾å¼æ–­è¨€é£æ ¼ï¼Œç„¶è€Œå½“shouldé£æ ¼å¯åŠ¨é“¾å¼æ–­è¨€æ—¶å°†å¯èƒ½åœ¨IEæµè§ˆå™¨ä¸‹å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå› æ­¤è¦æ³¨æ„æµè§ˆå™¨å…¼å®¹æ€§ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰https://github.com/power-assert-js/power-assert è¿™æ ·çš„ç¥å™¨ï¼Œä¸»è¦æ˜¯é‡åˆ°æŠ¥é”™ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯æ›´ç²¾å‡†ä¸€ç‚¹ï¼ŒAvaæµ‹è¯•æ¡†æ¶å°±æ˜¯ç”¨çš„å®ƒã€‚

## VSCodeæ’ä»¶

vscodeæ’ä»¶ [https://marketplace.visualstudio.com/items?itemName=connor4312.nodejs-testing](https://marketplace.visualstudio.com/items?itemName=connor4312.nodejs-testing)

![Untitled](img/Untitled%203.png)

# å­¦ä¼šCI/CD

æ ‡å‡†å¼€å‘æµç¨‹é‡Œï¼Œåœ¨ä¹‹å‰ï¼Œå¼€å‘æµ‹è¯•å‘å¸ƒå¯èƒ½æ˜¯ä¸‰ä¸ªäººï¼Œç”±äºDevOpsçš„æµè¡Œå¯¼è‡´å¾ˆå¤šæ—¶å€™å¼€å‘æµ‹è¯•å‘å¸ƒæ˜¯ä¸€ä¸ªäººï¼Œäºæ˜¯è¡ç”Ÿå‡ºäº†å¾ˆå¤šCI/CDå¹³å°ã€‚

![Untitled](img/Untitled%204.png)

ä¸¾ä¸ªä¾‹å­ï¼Œä»¥å‰æˆ‘ä»¬å‘å¸ƒnpmæ¨¡å—ï¼Œåœ¨æœ¬åœ°æ‰§è¡Œnpm publishå³å¯ã€‚ç°åœ¨æµè¡Œçš„æ–¹å¼æ˜¯åœ¨ä»£ç mergeåˆ°mainåˆ†åˆ†æ”¯çš„æ—¶å€™è§¦å‘CDï¼Œåœ¨github actionsä¸Šç›´æ¥å‘å¸ƒã€‚è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ›´åŠ ä¾¿åˆ©ï¼Œä½†ä¹Ÿä½¿å¾—å­¦ä¹ å†…å®¹å˜å¤šäº†ã€‚

ä¸‹é¢æˆ‘ä»¬å°±è®²è®²CI/CD

## ä½¿ç”¨Github Actions

æŒç»­é›†æˆï¼ˆContinuous Integrationï¼ŒCIï¼‰æ˜¯ä¸€ç§è½¯ä»¶å¼€å‘å®è·µï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹ï¼Œæ¥ç¡®ä¿ä»£ç çš„è´¨é‡å’Œç¨³å®šæ€§ã€‚CIçš„ç›®çš„æ˜¯å°½æ—©å‘ç°å’Œè§£å†³ä»£ç ä¸­çš„é—®é¢˜ï¼Œä»¥ä¾¿å¿«é€Ÿäº¤ä»˜é«˜è´¨é‡çš„è½¯ä»¶ã€‚

åœ¨CIä¸­ï¼Œå¼€å‘è€…å°†ä»£ç æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­ï¼Œç„¶åè‡ªåŠ¨è§¦å‘æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹ã€‚å¦‚æœæ„å»ºæˆ–æµ‹è¯•å¤±è´¥ï¼Œå¼€å‘è€…ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œä»¥ä¾¿åŠæ—¶ä¿®å¤é—®é¢˜ã€‚è¿™æ ·å¯ä»¥é¿å…åœ¨éƒ¨ç½²æ—¶å‡ºç°é—®é¢˜ï¼Œå¹¶ä¸”å¯ä»¥æé«˜å¼€å‘æ•ˆç‡å’Œè½¯ä»¶è´¨é‡ã€‚

GitHub Actionsï¼ˆåŒç±»äº§å“ CircleCI ã€TravisCIï¼‰æ˜¯GitHubæä¾›çš„ä¸€ç§æŒç»­é›†æˆå’Œéƒ¨ç½²å·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²GitHubä»“åº“ä¸­çš„ä»£ç ã€‚å®ƒä¸GitHubç´§å¯†é›†æˆï¼Œå¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®æ–‡ä»¶æ¥å®šä¹‰å·¥ä½œæµç¨‹ï¼ŒåŒæ—¶æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œæ“ä½œç³»ç»Ÿã€‚

ä½¿ç”¨GitHub Actionsï¼Œå¼€å‘è€…å¯ä»¥è½»æ¾åœ°è®¾ç½®è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•æµç¨‹ï¼Œä»¥ä¾¿åœ¨ä»£ç æäº¤æ—¶è‡ªåŠ¨è¿è¡Œã€‚å®ƒè¿˜æ”¯æŒè‡ªå®šä¹‰ç¯å¢ƒå˜é‡ã€å®šæ—¶è§¦å‘ã€é€šçŸ¥å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒé¡¹ç›®çš„éœ€æ±‚ã€‚

æ€»çš„æ¥è¯´ï¼ŒæŒç»­é›†æˆæ˜¯ä¸€ç§é‡è¦çš„è½¯ä»¶å¼€å‘å®è·µï¼Œå¯ä»¥æé«˜è½¯ä»¶è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚GitHub Actionsæ˜¯ä¸€ç§æ–¹ä¾¿ã€çµæ´»çš„CIå·¥å…·ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²GitHubä»“åº“ä¸­çš„ä»£ç ã€‚

```bash
$ cat .github/workflows/main.yml
name: Node.js CI

on: ["push", "pull_request"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"
      - run: npm install
      - run: npm test
      - run: npm run test:coverage
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          file: ./coverage/lcov.info
```

è¿™é‡Œé¢é¡¶ä¸€ä¸ª2ä¸ªä»»åŠ¡

1ã€Use Node.js

2ã€Upload coverage reports to Codecov

æŸ¥çœ‹actions

![Untitled](img/Untitled%205.png)

æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡ä»£ç æäº¤è§¦å‘çš„ciè®°å½•

![Untitled](img/Untitled%206.png)

## æµ‹è¯•è¦†ç›–ç‡

ä½¿ç”¨c8åšæµ‹è¯•è¦†ç›–ç‡ç”Ÿæˆã€‚

```bash
"scripts": {
	"test:coverage": "c8 tsx --test test/*.ts",
}
```

å¢åŠ é…ç½®.c8rc.jsonï¼Œæ³¨æ„é…ç½®ä¸­çš„reporteré‡Œçš„lcovæ˜¯å¿…é¡»é…ç½®çš„ã€‚

```bash
{
  "reporter": [
    "lcov",
    "text",
    "html"
  ]
}
```

æ‰§è¡Œnpm run test:coverageå°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„æµ‹è¯•è¦†ç›–ç‡æ–‡ä»¶äº†ã€‚

æµ‹è¯•è¦†ç›–ç‡ä¼šæ”¾åœ¨coverageç›®å½•ä¸‹é¢ï¼Œæ‰“å¼€coverage/index.htmlæ–‡ä»¶ã€‚

![Untitled](img/Untitled%207.png)

![Untitled](img/Untitled%208.png)

æµ‹è¯•è¦†ç›–ç‡æ˜¯ä¿è¯æµ‹è¯•æœ‰æ•ˆçš„å¿…å¤‡æ‰‹æ®µã€‚

è¿˜æ˜¯ä»¥ä¹‹å‰çš„ä»£ç ä¸¾ä¾‹

```bash
import { IPerson } from "..";

export class HelloWorld implements IPerson {
  async sayHi(name: string): Promise<void> {
    // è°ƒç”¨Promiseå‡½æ•°
    const text = await this.helloworld(name);
    console.log(text);
  }

  private helloworld(name?: string): Promise<string> {
    return new Promise(function (resolve, reject) {
      if (name) {
        resolve(`Hello ${name}!`);
      } else {
        reject(new Error("fail"));
      }
    });
  }
}
```

å¦‚æœåªæ˜¯æµ‹è¯•sayHiï¼Œä»£ç å¦‚ä¸‹ã€‚

```bash
import { test, describe } from "node:test";
import assert from "node:assert";

import { HelloWorld } from "../src/helloworld";
import { IPerson } from "..";

describe("test suite", function () {
  test("test if works correctly", async function (t) {
    const log = t.mock.method(global.console, "log");

    assert.strictEqual(log.mock.callCount(), 0);
    // call hello world say method
    const cli: IPerson = new HelloWorld();
    await cli.sayHi("liangqi");

    assert.strictEqual(log.mock.callCount(), 1);
  });
});
```

æ­¤æ—¶æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡89.47%

```bash
$ npm run test:coverage

> your-first-nodejs-helloworld-with-ts@1.0.0 test:coverage
> c8 tsx --test test/*.ts

Hello liangqi!
â–¶ test suite
  âœ” test if works correctly (0.864584ms)
â–¶ test suite (1.637167ms)

â„¹ tests 1
â„¹ suites 1
â„¹ pass 1
â„¹ fail 0
â„¹ cancelled 0
â„¹ skipped 0
â„¹ todo 0
â„¹ duration_ms 158.421208
---------------|---------|----------|---------|---------|-------------------
File           | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
---------------|---------|----------|---------|---------|-------------------
All files      |   89.47 |    83.33 |     100 |   89.47 |
 helloworld.ts |   89.47 |    83.33 |     100 |   89.47 | 15-16
---------------|---------|----------|---------|---------|-------------------
```

æ­¤æ—¶æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šï¼Œå…·ä½“å¦‚ä¸‹

![Untitled](img/Untitled%209.png)

éå¸¸æ˜æ˜¾æ˜¯helloworldä¸­çš„elseé€»è¾‘æ²¡æœ‰è¦†ç›–ã€‚

ä¿®æ”¹æµ‹è¯•ä»£ç ï¼Œå¢åŠ ä¸‹é¢çš„ä»£ç ã€‚

```bash
test("test if works incorrectly", async function () {
  const cli: IPerson = new HelloWorld();
  assert.rejects(async () => await cli.sayHi(), new Error("fail"));
});
```

åœ¨æ‰§è¡Œæµ‹è¯•è¦†ç›–ç‡è„šæœ¬ï¼Œæ­¤æ—¶å°±100%äº†ã€‚

## Badge

åœ¨README.mdæ–‡ä»¶ä¸­çš„badgeæ˜¯ä¸€ç§å¾½ç« ï¼Œé€šå¸¸ç”¨äºå±•ç¤ºé¡¹ç›®çš„ä¸€äº›ä¿¡æ¯æˆ–çŠ¶æ€ã€‚å¾½ç« å¯ä»¥æ˜¾ç¤ºé¡¹ç›®çš„æ„å»ºçŠ¶æ€ã€æµ‹è¯•è¦†ç›–ç‡ã€ç‰ˆæœ¬å·ã€è®¸å¯è¯ã€æ”¯æŒçš„å¹³å°ç­‰ç­‰ã€‚è¿™äº›å¾½ç« å¯ä»¥å¸®åŠ©è¯»è€…å¿«é€Ÿäº†è§£é¡¹ç›®çš„ä¸€äº›å…³é”®ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¢åŠ é¡¹ç›®çš„å¯ä¿¡åº¦å’Œå¸å¼•åŠ›ã€‚å¾½ç« é€šå¸¸æ˜¯é€šè¿‡å›¾åƒæˆ–é“¾æ¥çš„å½¢å¼å‘ˆç°åœ¨README.mdæ–‡ä»¶ä¸­ã€‚

ä¾‹å¦‚æˆ‘ä»¬çš„é¡¹ç›®README.mdå±•ç¤ºå¦‚ä¸‹ã€‚

![Untitled](img/Untitled%2010.png)

ç¤ºä¾‹1ï¼šæµ‹è¯•é€šè¿‡

![Untitled](img/Untitled%2011.png)

```tsx
![build status](https://github.com/npmstudy/your-first-nodejs-helloworld-with-ts/actions/workflows/main.yml/badge.svg)
```

ç¤ºä¾‹1ï¼šæµ‹è¯•è¦†ç›–ç‡

![Untitled](img/Untitled%2012.png)

[https://glebbahmutov.com/blog/trying-node-test-runner/#code-coverage](https://glebbahmutov.com/blog/trying-node-test-runner/#code-coverage)

<aside>
ğŸ“¢ è¯¾åç»ƒä¹ ï¼šè‡ªå·±é€šè¿‡github actionsï¼Œåœ¨æ¯æ¬¡mainåˆ†æ”¯è¢«åˆå¹¶ä¹‹åè‡ªåŠ¨å‘npmåŒ…ã€‚

</aside>

# å°ç»“

æœ¬ç« èŠ‚ä¸»è¦è®²è§£æµ‹è¯•æŠ€å·§ï¼Œtsæµ‹è¯•é™¤äº†æ¯”jsæµ‹è¯•å¤šäº†ç±»å‹æµ‹è¯•å¤–ï¼Œå…¶ä»–éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œä¸»è¦Node.jså†…ç½®çš„test runnerï¼Œåœ¨ä¸å¢åŠ æ¨¡å—çš„å‰æä¸‹å°±å¯ä»¥æå®šï¼Œç›¸å¯¹æ¥è¯´æ›´ç®€å•ï¼Œå¯¹æœªæ¥Node.js v20è¿™ä¸€æµ‹è¯•æ½®æµèƒ½æŒæ¡ä¹Ÿæ˜¯å¥½çš„ã€‚

è‡³äºé«˜çº§æµ‹è¯•æŠ€å·§å’ŒCI/CDï¼Œèƒ½æŒæ¡å¤šå°‘æŒæ¡å¤šå°‘ï¼Œæ¯•ç«Ÿæµ‹è¯•æ˜¯é«˜é˜¶æŠ€å·§ï¼Œè€Œspyã€mockè¿™äº›åˆæ˜¯é«˜é˜¶ä¸­çš„é«˜çº§æŠ€å·§ï¼Œä¸å¿…å¼ºæ±‚å¿…é¡»æŒæ¡ã€‚

å¦‚æœèƒ½æŒæ¡æ›´å¥½ï¼Œå¯¹ç†è§£å¼€æºé¡¹ç›®ï¼Œè‡ªå·±å­¦ä¹ æ˜¯å¤šæœ‰è£¨ç›Šçš„ã€‚

# å¼€æºæœ€ä½³å®è·µ

åœ¨ <https://github.com/npmstudy/your-node-v20-monorepo-project> é‡Œï¼Œæˆ‘ä»¬ç”¨åˆ°çš„æŠ€æœ¯æ ˆå¦‚ä¸‹ã€‚

> - [Tsup](https://tsup.egoist.dev/) as a TypeScript universal package.
> - [Tsx](https://github.com/esbuild-kit/tsx) as a Node.js enhanced with esbuild to run TypeScript & ESM
> - [Tsd](https://github.com/SamVerschueren/tsd) as type test runner
> - [Tsdoc](https://tsdoc.org/) as document
> - [PNPM](https://pnpm.io/workspaces) as workspace manager and package manager.
> - [Vitest](https://vitest.dev/) as a test runner.
> - [Size Limit](https://github.com/ai/size-limit) as a size limit plugin.
> - [Prettier](https://prettier.io/) as a code formatter.
> - [ESLint](https://eslint.org/) as a code linter.
> - [NX](https://nx.dev) as cacheable operations.
> - [Changesets](https://github.com/changesets/changesets/) as a way to manage changes and releases.
> - [c8](https://www.npmjs.com/package/c8) as coverage
> - [supertest](https://www.npmjs.com/package/supertest) as server test
> - [cypress](https://www.cypress.io/) as e2e test

è¿è¡ŒTSçš„4ä¸ªï¼ˆå·²è®²è¿‡ï¼‰

1. tsup
2. tsx
3. tsd
4. tsdoc

æ¨¡å—å®‰è£…å’Œmonorepo

1. pnpm

æµ‹è¯•

1. Vitest
2. c8ï¼ˆå·²è®²è¿‡ï¼‰
3. supertest
4. cypress

å…¶ä»–

1. Size-limit
2. NX
3. ESLint
4. Prettier
5. Changesets

å…¶ä¸­ESLintå’ŒPrettierå‰ç«¯åŒå­¦éƒ½ç†Ÿæ‚‰ï¼Œè¿™é‡Œå°±ä¸ç»†è®²äº†ã€‚

- ESLintæ˜¯ä¸€ä¸ªç”¨äºJavaScriptå’ŒJSXä»£ç çš„é™æ€ä»£ç åˆ†æå·¥å…·ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®å¤æ½œåœ¨çš„é—®é¢˜ï¼Œä»¥ç¡®ä¿ä»£ç çš„è´¨é‡å’Œä¸€è‡´æ€§ã€‚
- Prettieræ˜¯ä¸€ä¸ªä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œç”¨äºè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ä»¥ä¿æŒä¸€è‡´çš„ä»£ç é£æ ¼ã€‚å®ƒæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼ŒåŒ…æ‹¬JavaScriptã€CSSã€HTMLã€JSONç­‰ã€‚Prettierå¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿã€å‡†ç¡®åœ°æ ¼å¼åŒ–ä»£ç ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å®ƒå¯ä»¥ä¸å…¶ä»–ä»£ç æ£€æŸ¥å·¥å…·ï¼ˆå¦‚ESLintï¼‰é…åˆä½¿ç”¨ï¼Œä»¥ç¡®ä¿ä»£ç çš„è´¨é‡å’Œä¸€è‡´æ€§ã€‚

å®ƒä¿©æ˜¯VSCodeéå¸¸å¸¸è§çš„æ­æ¡£ã€‚

## Pnpm

åŒ…ç®¡ç†æ¼”è¿›å†å²ï¼Œå‚è€ƒ[https://zhuanlan.zhihu.com/p/582229306](https://zhuanlan.zhihu.com/p/582229306)ï¼Œå„ä¸ªåŒ…ç®¡ç†å™¨å¯¹æ¯”å¦‚ä¸‹ã€‚

pnpmåœ¨2018å¹´å‘å¸ƒï¼Œä½œä¸ºnpmçš„æ›´å¿«é€Ÿå’Œæ›´é«˜æ•ˆçš„æ›¿ä»£å“ã€‚

![Untitled](img/Untitled%202.png)

é€‰æ‹©pnpmçš„åŸå› ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯å®‰è£…é€Ÿåº¦å¿«ï¼Œå‚è€ƒå®˜æ–¹çš„[https://pnpm.io/benchmarks](https://pnpm.io/benchmarks)åŸºå‡†æµ‹è¯•æ•°æ®ã€‚

| è¡Œä¸º | ç¼“å­˜ | lockfile | node_modules | npm | **pnpm** | Yarn | Yarn PnP |
| --- | --- | --- | --- | --- | --- | --- | --- |
| install |  |  |  | 34.3s | 13.2s | 22.1s | 20.2s |
| install | âœ” | âœ” | âœ” | 2.5s | 1.6s | 695ms | n/a |
| install | âœ” | âœ” |  | 9.5s | 4.8s | 8.8s | 668ms |
| install | âœ” |  |  | 15.5s | 9.3s | 22.8s | 15.2s |
| install |  | âœ” |  | 19.3s | 9.8s | 8.9s | 670ms |
| install | âœ” |  | âœ” | 2.8s | 3.4s | 16s | n/a |
| install |  | âœ” | âœ” | 2.5s | 1.7s | 681ms | n/a |
| install |  |  | âœ” | 2.8s | 8.8s | 16.6s | n/a |
| update | n/a | n/a | n/a | 9.2s | 5.8s | 8.7s | 16.9s |

è¿˜æœ‰ä¸€äº›å…¶ä»–ç‰¹æ€§

![Untitled](img/Untitled%203.png)

pnpmä½¿ç”¨çš„æ˜¯npm version 2.xç±»ä¼¼çš„æ ‘å½¢ç»“æ„ï¼ŒåŒæ—¶ä½¿ç”¨.pnpm ä»¥å¹³é“ºçš„å½¢å¼å‚¨å­˜ç€æ‰€æœ‰çš„åŒ…ã€‚è¿™é‡Œçš„.pnpmä¸ºè™šæ‹Ÿå­˜å‚¨ç›®å½•ï¼Œè¯¥ç›®å½•é€šè¿‡`<package-name>@<version>`æ¥å®ç°ç›¸åŒæ¨¡å—ä¸åŒç‰ˆæœ¬ä¹‹é—´éš”ç¦»å’Œå¤ç”¨ï¼Œç”±äºå®ƒåªä¼šæ ¹æ®é¡¹ç›®ä¸­çš„ä¾èµ–ç”Ÿæˆï¼Œå¹¶ä¸å­˜åœ¨æå‡ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå­˜åœ¨ä¹‹å‰æåˆ°çš„**Phantom dependencies**é—®é¢˜ï¼

ç„¶åä½¿ç”¨Store + Linkså’Œæ–‡ä»¶èµ„æºè¿›è¡Œå…³è”ã€‚ç®€å•è¯´pnpmä¼šæŠŠåŒ…ä¸‹è½½åˆ°ä¸€ä¸ªå…¬å…±ç›®å½•ï¼Œå¦‚æœæŸä¸ªä¾èµ–åœ¨ store ç›®å½•ä¸­å­˜åœ¨äº†è¯ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥ä» store ç›®å½•é‡Œé¢å» hard-linkï¼Œé¿å…äº†äºŒæ¬¡å®‰è£…å¸¦æ¥çš„æ—¶é—´æ¶ˆè€—ï¼Œå¦‚æœä¾èµ–åœ¨ store ç›®å½•é‡Œé¢ä¸å­˜åœ¨çš„è¯ï¼Œå°±ä¼šå»ä¸‹è½½ä¸€æ¬¡ã€‚

é€šè¿‡Store + hard linkçš„æ–¹å¼ï¼Œä¸ä»…è§£å†³äº†é¡¹ç›®ä¸­çš„NPM doppelgangersé—®é¢˜ï¼Œé¡¹ç›®ä¹‹é—´ä¹Ÿä¸å­˜åœ¨è¯¥é—®é¢˜ï¼Œä»è€Œå®Œç¾è§£å†³äº†npm3+å’Œyarnä¸­çš„åŒ…é‡å¤é—®é¢˜ï¼

![Untitled](img/Untitled%204.png)

pnpmé™¤äº†å®‰è£…é€Ÿåº¦å¿«ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´ï¼Œé¿å…å¹½çµä¾èµ–ç­‰ä¼˜åŒ–ï¼Œä¹Ÿå†…ç½®äº†å¯¹monorepoçš„æ”¯æŒã€‚ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ–°å»ºpnpm-workspace.yamlæ–‡ä»¶ï¼Œå¹¶å£°æ˜å¯¹åº”çš„å·¥ä½œåŒºå°±å¥½ã€‚

```bash
$ cat pnpm-workspace.yaml
packages:
  - 'example'
  - 'packages/*'

```

å‰©ä¸‹çš„å°±æ˜¯è¿è¡Œæ—¶å¤„ç†ã€‚ä¹‹å‰nx run-manyè§£å†³äº†monorepoå­æ¨¡å—è¿è¡Œçš„é—®é¢˜ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨æ ¹ç›®å½•æ‰§è¡ŒæŸä¸ªé¡¹ç›® çš„æ„å»ºè„šæœ¬ï¼Œéœ€è¦é€šè¿‡â€”filteræˆ–-Fè¿‡æ»¤ä¹‹åï¼Œå†æ‰§è¡Œï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚

```bash
$ pnpm -F example dev
```

ä»¥ä¸Šéƒ½æ˜¯pnpmçš„ä¼˜ç‚¹ï¼Œå…¶å®pnpmçš„æ¼”è¿›è¿˜æ˜¯æ¯”è¾ƒå¿«çš„ï¼Œæ¯”å¦‚pnpm v7å’Œpnpm v8ç‰ˆæœ¬å·®å¼‚è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä¸”ä¸å®Œå…¨å…¼å®¹ã€‚ä½†æ•´ä¸ªç¤¾åŒºæ˜¯æ¯”è¾ƒæ´»è·ƒçš„ï¼Œ

<aside>
ğŸ’¡ éƒ½è¯´Node.jså’Œå‰ç«¯å¤æ‚ï¼Œå…¶å®æ˜¯èƒŒåå·¥ç¨‹å¤æ‚åº¦å¯¼è‡´çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¹ˆå¤šä¾èµ–ï¼Œè¿™ä¹ˆå¤šç‰ˆæœ¬ï¼Œä¹Ÿä¸ä¼šå‡ºç°å¹»å½±ä¾èµ–è¿™æ ·çš„é—®é¢˜ã€‚å…¶å®ï¼Œå¯¹ç”¨çš„äººæ¥è¯´æ— æ„Ÿçš„ï¼Œæˆ‘å°±ç”¨pnpm v8ï¼Œåƒå…¶ä»–ç¤¾åŒºä¸€æ ·ï¼Œä¹Ÿæ²¡é—®é¢˜çš„ã€‚çœŸæ­£çš„é—®é¢˜æ˜¯Node.jså’Œå‰ç«¯å˜åŒ–å¤ªå¿«ï¼Œä½ åœ¨è¾ƒçŸ­æ—¶é—´å†…ï¼Œæ€»å¯èƒ½ä¼šé‡åˆ°pnpm v7çš„ä»£ç ï¼Œç”šè‡³äº’ç›¸åˆ‡æ¢ã€‚

</aside>

## Vitest

- **A Vite-native unit test framework.**

    **It's fast!**

ä¼˜ç‚¹ï¼š

1. åŸºäºviteæœºåˆ¶ï¼Œæ€§èƒ½æä½³ï¼Œæ¯”jestå¿«å¾ˆå¤šï¼Œ
2. å¯¹esmæ”¯æŒæå¥½
3. å…¼å®¹jest api
4. å¾ˆå¤šæŠ€æœ¯é€‰å‹ä¹Ÿéƒ½æ˜¯éå¸¸æ£’ï¼Œæ¯”å¦‚tinypoolï¼Œéƒ½æ˜¯å¾ˆç»å…¸çš„ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦ä»è¯·æ±‚å¼€å§‹æ¥æµ‹è¯•nodeæœåŠ¡æ¥å£è¿”å›çš„æ•°æ®æ˜¯å¦æ­£å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´è¿›è¡Œä¸€ä¸ªæ•´ä½“æ€§æµ‹è¯•ï¼Œé‚£ä¹ˆ superTest å°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ã€‚superTestå¯ä»¥å¸®åŠ©æˆ‘ä»¬å»è¯·æ±‚æœ¬åœ° koa æˆ–è€… expressè¿™ç±»webæ¡†æ¶æ‰€ç¼–å†™çš„è·¯ç”±æ¥å£ï¼Œè€Œä¸”å¯¹æ¥å£è¿”å›çš„çŠ¶æ€ç ã€æ•°æ®ç­‰è¿›è¡Œæ–­è¨€æ ¡éªŒã€‚

å®ƒæœ¬èº«ä¸ä¾èµ–ä»»ä½•æµ‹è¯•æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠå®ƒä¸¢åˆ°mochaçš„æµ‹è¯•ç”¨ä¾‹ä¸­æ‰§è¡Œï¼š

å…ˆå†™ä¸€ä¸ªç®€å•çš„Koaçš„Hello worldã€‚è§app.js

```js
import Koa from "koa";
const app = new Koa();

// response
app.use((ctx) => {
  ctx.body = "Hello Koa";
});

export default app;
```

å†å†™ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œrun.js

```js
import app from "./index.js";

app.listen(3000);
```

æ­¤æ—¶ï¼Œæ‰§è¡Œnode run.jså°±å¯ä»¥å¯åŠ¨æœåŠ¡äº†ã€‚ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æµ‹è¯•å¦‚ä½•ç¼–å†™ã€‚

```js
import { expect, test } from "vitest";
import supertest from "supertest";
import app from "./index.js";

test("koa app", async () => {
  const res = await supertest(app.callback()).get("/");

  expect(res.type).toEqual("text/plain");
  expect(res.status).toEqual(200);
  expect(res.text).toEqual("Hello Koa");
});
```

è¿™ä¸ªä»£ç å’Œæˆ‘ä»¬åœ¨Node.js v20çš„test runneré‡Œå‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚é€šè¿‡ä¸‹é¢å‘½ä»¤å³å¯è¿è¡Œæµ‹è¯•ã€‚

```bash
$ npx vitest run

 RUN  v0.34.6 /Users/alfred/workspace/npmstudy/vitest-with-supertest

 âœ“ index.test.js (1)
   âœ“ koa app

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  11:56:53
   Duration  232ms (transform 17ms, setup 0ms, collect 69ms, tests 8ms, environment 0ms, prepare 44ms)
```

è¯´æ˜ã€‚

- vitestä¸å¸¦runå‚æ•°ï¼Œæ˜¯watchè¿è¡Œæ¨¡å¼ï¼Œå’Œjestç±»ä¼¼
- vitestå¸¦runå‚æ•°ï¼Œæ˜¯å•æ¬¡è¿è¡Œæ¨¡å¼

## Cypress

å®‰è£…

```bash
$ npm install cypress --save-dev --registry=https://registry.npmmirror.com
```

é€šè¿‡npx cypress openæ‰“å¼€ã€‚

```bash
$ npx cypress open
It looks like this is your first time using Cypress: 13.3.0

âœ”  Verified Cypress! /Users/alfred/Library/Caches/Cypress/13.3.0/Cypress.app

Opening Cypress...

DevTools listening on ws://127.0.0.1:54097/devtools/browser/dc560ea2-0aad-47a4-9461-1e160b19a5a3
```

![Untitled](img/Untitled%205.png)

![Untitled](img/Untitled%206.png)

![Untitled](img/Untitled%207.png)

![Untitled](img/Untitled%208.png)

ä¿®æ”¹ä»£ç ï¼Œæ‰‹åŠ¨æ‰§è¡Œnode run.jså¯åŠ¨æœåŠ¡ã€‚

```js
describe("template spec", () => {
  it("passes", () => {
    cy.visit("http://127.0.0.1:3000");
    cy.contains("Hello Koa");
  });
});
```

![Untitled](img/Untitled%209.png)

ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬æŠŠå¯åŠ¨æœåŠ¡æ”¾åˆ°cypress.config.jsé‡Œã€‚

```js
import { defineConfig } from "cypress";
import app from "./index.js";
export default defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
      on("before:run", async (details) => {
        /* ... */
        await app.listen(3000);
      });
    },
  },
});
```

æ­¤æ—¶ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ã€‚

```bash
$ npx cypress run

DevTools listening on ws://127.0.0.1:61755/devtools/browser/0a2f2716-10cb-49b9-a2c9-5163469574e9

====================================================================================================

  (Run Starting)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Cypress:        13.3.0                                                                         â”‚
  â”‚ Browser:        Electron 114 (headless)                                                        â”‚
  â”‚ Node Version:   v20.6.1 (/Users/alfred/.nvm/versions/node/v20.6.1/bin/node)                    â”‚
  â”‚ Specs:          1 found (spec.cy.js)                                                           â”‚
  â”‚ Searched:       cypress/e2e/**/*.cy.{js,jsx,ts,tsx}                                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Running:  spec.cy.js                                                                      (1 of 1)

  template spec
    âœ“ passes (27ms)

  1 passing (47ms)

  (Results)

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Tests:        1                                                                                â”‚
  â”‚ Passing:      1                                                                                â”‚
  â”‚ Failing:      0                                                                                â”‚
  â”‚ Pending:      0                                                                                â”‚
  â”‚ Skipped:      0                                                                                â”‚
  â”‚ Screenshots:  0                                                                                â”‚
  â”‚ Video:        false                                                                            â”‚
  â”‚ Duration:     0 seconds                                                                        â”‚
  â”‚ Spec Ran:     spec.cy.js                                                                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

====================================================================================================

  (Run Finished)

       Spec                                              Tests  Passing  Failing  Pending  Skipped
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ âœ”  spec.cy.js                                42ms        1        1        -        -        - â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    âœ”  All specs passed!                         42ms        1        1        -        -        -
```

Cypresså†™e2eæµ‹è¯•è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œå®ƒä¹Ÿæ”¯æŒæµ‹è¯•è¦†ç›–ç‡ï¼Œä¹Ÿå¯ä»¥ç”Ÿäº§reporterï¼Œå’Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« èŠ‚å­¦åˆ°çš„c8ç±»ä¼¼ï¼Œå¤§å®¶å¦‚æœæ„Ÿå…´è¶£ä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸€ä¸‹ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒCypressè¿˜æ”¯æŒç»„ä»¶çº§åˆ«æµ‹è¯•ï¼Œå¯ä»¥è¯´åˆæ˜¯å¡«è¡¥äº†ä¸€å—ç©ºç™½ï¼Œæ„ä¹‰éå‡¡ï¼Œå¯¹äºå¼€å‘ç»„ä»¶åº“æ¥è¯´ï¼Œä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„åŠŸèƒ½ã€‚

## Size-limit

size-limit æ˜¯ä¸€ä¸ªé˜²æ­¢ JavaScript åº“è†¨èƒ€çš„å·¥å…·ï¼Œç”¨äºæ§åˆ¶æ–‡ä»¶åŒ…çš„å¤§å°ã€‚å¦‚æœä¸å°å¿ƒæ·»åŠ äº†å¤§é‡çš„ä¾èµ–å…³ç³»ï¼Œsize-limit ä¼šå¼•å‘é”™è¯¯ã€‚

limit-size æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶æ–‡ä»¶åŒ…å¤§å°çš„å·¥å…·ï¼Œå®ƒå¯ä»¥è¯»å–æ–‡ä»¶çš„å¤§å°ï¼Œå¹¶ä¸è®¾ç½®çš„æ–‡ä»¶å¤§å°è¿›è¡Œæ¯”è¾ƒã€‚

![Untitled](img/Untitled%2010.png)

ä½¿ç”¨GitHubæ“ä½œSize Limitå°†åœ¨æ‹‰å–è¯·æ±‚è®¨è®ºä¸­ä½œä¸ºè¯„è®ºå‘å¸ƒæ†ç»‘å¤§å°æ›´æ”¹ã€‚

![Untitled](img/Untitled%2011.png)

ä¹Ÿå¯ä»¥ç»“åˆ<https://github.com/statoscope/statoscope> è¿›è¡Œåˆ†æã€‚

Â [Statoscope: A Course Of Intensive Therapy For Your Bundle](https://www.smashingmagazine.com/2022/02/statoscope-course-intensive-therapy-bundle/).

![Untitled](img/Untitled%2012.png)

## Nx

<aside>
ğŸ’¡ Nrwl(å¼€æºæ„å»ºç³»ç»ŸNXèƒŒåçš„å…¬å¸)å·²ç»æ¥ç®¡äº†Lernaã€‚NXæ˜¯ä¸€ä¸ªç”±å‰è°·æ­Œå‘˜å·¥å¼€å‘çš„æ„å»ºç³»ç»Ÿï¼Œå®ƒåˆ©ç”¨äº†è°·æ­Œå†…éƒ¨å·¥å…·ä½¿ç”¨çš„è®¸å¤šæŠ€æœ¯ã€‚Lerna v5æ˜¯è¿™ç§æ–°ç®¡ç†æ–¹å¼ä¸‹çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå®ƒæ›´æ–°äº†è¿‡æ—¶çš„åŒ…ï¼Œå¹¶å¼€å§‹å¯¹å­˜å‚¨åº“æœ¬èº«è¿›è¡Œä¸€äº›æ¸…ç†ã€‚ä»V5.1+å¼€å§‹ï¼ŒLernaæä¾›äº†é›†æˆNXçš„æ–°å¯èƒ½æ€§ï¼Œå¹¶å°†è®¸å¤šä»»åŠ¡è°ƒåº¦å·¥ä½œæ¨è¿Ÿåˆ°NXã€‚

</aside>

åœ¨ä½¿ç”¨Monorepoæ—¶ï¼Œä½ ä¸€å®šå¬è¯´è¿‡ Nxã€‚ç®€è€Œè¨€ä¹‹ï¼ŒNx å¯ä»¥åŠ å¿«å’Œç®€åŒ–ä¸Monorepoçš„å·¥ä½œï¼Œå¹¶æä¾›æœ‰ç”¨çš„å®ç”¨ç¨‹åºã€‚

å®˜æ–¹ä»‹ç»ï¼š

> Nxæ˜¯ä¸€ä¸ªæ™ºèƒ½ã€å¿«é€Ÿå’Œå¯æ‰©å±•çš„æ„å»ºç³»ç»Ÿï¼Œå…·æœ‰ä¸€æµçš„Monorepoæ”¯æŒå’Œå¼ºå¤§çš„é›†æˆã€‚
>

Nxçš„ç›®æ ‡æ˜¯ï¼š

- åŠ å¿«ä½ çš„å‰ç«¯é¡¹ç›®å·¥ç¨‹åŒ–
- æä¾›ä¸€æµçš„å¼€å‘ä½“éªŒ

å¤§éƒ¨åˆ†æƒ…å†µéœ€è¦äº†è§£çš„å°±æ˜¯ä¸‹é¢6ä¸ªæŒ‡ç‚¹å°±å¤Ÿäº†ã€‚

- nx run-many
- dependency graph + nx affected
- nx-enforce-module-boundaries es-linting
- computation cache
- nx cloud
- buildable libs

nxä¼šè‡ªåŠ¨å¼•å…¥ä¸Šä¸€æ¬¡buildçš„cacheç¼“å­˜ï¼Œä»è€ŒåŠ å¿«ç¼–è¯‘é€Ÿåº¦.åœ¨[How Caching Works](https://nx.dev/concepts/how-caching-works)è¿™ç¯‡æ–‡ç« ä¸­éå¸¸è¯¦ç»†åœ°è¯´æ˜äº† nx ç¼“å­˜æ„å»ºç»“æœçš„æœºåˆ¶ï¼š

nx ä¼šè®¡ç®—å½“å‰æ‰§è¡Œçš„ target çš„ Hash ä½œä¸º cache keyï¼Œåœ¨ target æ‰§è¡Œå®ŒæˆåæŠŠæ„å»ºè¾“å‡ºï¼ˆåŒ…æ‹¬ç»ˆç«¯è¾“å‡ºã€æ„å»ºç»“æœæ–‡ä»¶ï¼‰ä½œä¸ºç¼“å­˜å†…å®¹å­˜å‚¨èµ·æ¥ã€‚

![Untitled](img/Untitled%2013.png)

æœ€å¸¸ç”¨çš„åŠ¨ä½œ

- å°†æ‰€æœ‰çš„å­é¡¹ç›®ç»Ÿä¸€æ‰“åŒ…ç¼–è¯‘ï¼Œå‘½ä»¤:`npx nx run-many --target=build`
- å¦‚æœä¸éœ€è¦ä½¿ç”¨cacheç¼“å­˜ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤:`npx nx run-many --target=build --skip-nx-cache`
- å¦‚æœéœ€è¦æŸ¥çœ‹å½“å‰å­é¡¹ç›®ä¾èµ–çš„é¡¹ç›®æ˜¯å¦è¢«ä¿®æ”¹ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼š`npx nx affected --target=build`
- å¦‚æœéœ€è¦æŸ¥çœ‹å½“å‰å­é¡¹ç›®ä¾èµ–çš„å›¾ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼š`npx nx graph`

æ¯”å¦‚ä¾èµ–å¦‚ä¸‹ã€‚

```bash
$ pnpm project-graph

> your-node-v20-monorepo-project@ project-graph /Users/alfred/workspace/npmstudy/your-node-v20-monorepo-project
> nx graph

 >  NX   Project graph started at http://127.0.0.1:4211/projects
```

![Untitled](img/Untitled%2014.png)

nxé™¤äº†æœ¬åœ°æ¢æˆï¼Œå…¶å®è¿˜æ”¯æŒäº‘æœåŠ¡ï¼ˆremote cacheï¼‰ã€‚å³nx.appï¼Œå¦‚æœçœŸçš„å¯¹ci/cdæœ‰æå¼ºçš„éœ€æ±‚ï¼Œå…¶å®ä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘é€‰æ‹©çš„ã€‚

![Untitled](img/Untitled%2015.png)

åœ¨<https://github.com/npmstudy/your-node-v20-monoreopo-project> é¡¹ç›®é‡Œï¼Œæˆ‘ä»¬å…¶å®åªç”¨äº†éå¸¸ç®€å•çš„npm nx run-many

```json
{
  "scripts": {
    "build": "nx run-many -t build",
    "build:fast": "nx run-many -t build:fast",
    "dev": "nx run-many -t dev",
    "test": "nx run-many -t test",
  }
}
```

è™½ç„¶å¤šäº†ä¸€ä¸ªnxæ¨¡å—ï¼Œä½†æ‰§è¡Œçš„æ—¶å€™èƒ½å¤Ÿåˆ©ç”¨æœ¬åœ°ç¼“å­˜ï¼ŒåŠ å¿«æ‰“åŒ…ã€æµ‹è¯•é€Ÿåº¦ï¼Œå·²ç»æ˜¯éå¸¸å¥½çš„äº‹å„¿ã€‚

## Changesets

Changesets æ˜¯ä¸€ä¸ªç”¨äº Monorepo é¡¹ç›®ä¸‹ç‰ˆæœ¬ä»¥åŠ Changelog æ–‡ä»¶ç®¡ç†çš„å·¥å…·ã€‚ç›®å‰ä¸€äº›æ¯”è¾ƒç«çš„ Monorepo ä»“åº“éƒ½åœ¨ä½¿ç”¨è¯¥å·¥å…·è¿›è¡Œé¡¹ç›®çš„å‘åŒ…ä¾‹å¦‚ pnpmã€mobx ç­‰ã€‚

changesets ä¸»è¦å…³å¿ƒ monorepo é¡¹ç›®ä¸‹å­é¡¹ç›®ç‰ˆæœ¬çš„æ›´æ–°ã€changelog æ–‡ä»¶ç”Ÿæˆã€åŒ…çš„å‘å¸ƒã€‚ä¸€ä¸ª changeset æ˜¯ä¸ªåŒ…å«äº†åœ¨æŸä¸ªåˆ†æ”¯æˆ–è€… commit ä¸Šæ”¹åŠ¨ä¿¡æ¯çš„ md æ–‡ä»¶ï¼Œå®ƒä¼šåŒ…å«è¿™æ ·ä¸€äº›ä¿¡æ¯:

- éœ€è¦å‘å¸ƒçš„åŒ…
- åŒ…ç‰ˆæœ¬çš„æ›´æ–°å±‚çº§(éµå¾ª semver è§„èŒƒ)
- CHANGELOG ä¿¡æ¯

åœ¨ changesets å·¥ä½œæµä¼šå°†å¼€å‘è€…åˆ†ä¸ºä¸¤ç±»äººï¼Œä¸€ç±»æ˜¯é¡¹ç›®çš„ç»´æŠ¤è€…ï¼Œè¿˜æœ‰ä¸€ç±»ä¸ºé¡¹ç›®çš„å¼€å‘è€…ï¼Œä¸¤è€…çš„èŒè´£å¯ä»¥é€šè¿‡å¦‚ä¸‹æµç¨‹å›¾å¾ˆç®€æ´çš„è¡¨ç¤ºå‡ºæ¥:

![Untitled](img/Untitled%2016.png)

æ ¹æ®ä¸Šå›¾ï¼Œ changesets çš„å·¥ä½œæµç¨‹æ˜¯è¿™æ ·ï¼šå¼€å‘è€…åœ¨ Monorepo é¡¹ç›®ä¸‹è¿›è¡Œå¼€å‘ï¼Œå¼€å‘å®Œæˆåï¼Œç»™å¯¹åº”çš„å­é¡¹ç›®æ·»åŠ ä¸€ä¸ª changesets æ–‡ä»¶ã€‚é¡¹ç›®çš„ç»´æŠ¤è€…åé¢ä¼šé€šè¿‡ changesets æ¥æ¶ˆè€—æ‰è¿™äº›æ–‡ä»¶å¹¶è‡ªåŠ¨ä¿®æ”¹æ‰å¯¹åº”åŒ…çš„ç‰ˆæœ¬ä»¥åŠç”Ÿæˆ CHANGELOG æ–‡ä»¶ï¼Œæœ€åå°†å¯¹åº”çš„åŒ…å‘å¸ƒå‡ºå»ã€‚

å¸¸ç”¨çš„å‘½ä»¤åªæœ‰addã€versionã€publish

![Untitled](img/Untitled%2017.png)
